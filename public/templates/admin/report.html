{% extends "layouts/admin-master.html" %} 
{% block body %}
<div >
    
    <h3>委托列表:</h3>
    <div>
       
        <div style="width: 1035px; padding:2px;background-color: rgb(199, 217, 247); ">  

            site:
            <select id="inquirysite" name="sites" data-group="1" >
            </select>&nbsp;&nbsp;

            <span id="hide" style="display:none;">symbol: 
            <select id="inquirysymbol" name="symbols" data-group="1" >
            </select>&nbsp;&nbsp;&nbsp;&nbsp;</span>

            status:
            <select id="inquirystatus" name="statuss" >
                <option value="">--请选择--</option>
                <option value="wait">运行中</option>
                <option value="consign">已委托未成交</option>
                <option value="success">已完成</option>
                <option value="part_success">部分成功</option>
                <option value="will_cancel">已标记取消未完成</option>
                <option value="canceled">已取消</option>
                <option value="auto_retry">超时不同价格重新委托</option>
                <option value="failed">已失败</option>
            </select><br/>

            起始时间:<input size="16"  type="text" id="datetimeStart" class="form_datetime">--
            结束时间:<input size="16"  type="text" id="datetimeEnd" class="form_datetime">
           
            <input type="button" id="btnSearch" value="查询" />
            <button onClick="document.location.reload()">重置</button>
        </div>
       
            <!-- <table id="show" border="1" style="width: 1044px; background-color: rgb(199, 217, 247); ">  
            </table>  onLoad="goPage(1,10);" -->
            <div id="show" style="width: 1035px;"> 

            </div>

        <div id="FlexiGrid_ContentDiv" >
            <table id="FlexiGrid_ContentTable" style="display: none;">
            </table>
        </div>
        <div id="barcon" name="barcon"></div>
        <div name="customPager" id="flexiGridPager" for="FlexiGrid_ContentTable" style="padding-top: 4px; display: none;"></div>
        <input type="hidden" name="_csrf" value="{{_csrf}}" />
    </div>
</div>

{% endblock %} {% block scripts %}
<script src="../js/jquery-1.8.2.js" type="text/javascript"></script>
<script src="../js/plugins/bootstrap/3.3.5/js/bootstrap.min.js" type="text/javascript" language="utf-8"></script>
<script src="../js/lib/jquery.flexigrid.js" type="text/javascript"></script>
<script src="../js/common.js" type="text/javascript"></script>
<script src="../js/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js" type="text/javascript" language="utf-8"></script>
<script src="../js/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js" type="text/javascript" language="utf-8"></script>



<link rel="stylesheet" href="../js/plugins/bootstrap/3.3.5/css/bootstrap.min.css" />
<link rel="stylesheet" href="../js/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" type="text/css" media="screen"/>
<script type="text/javascript">
   

    var _business = {{ business | safe }};

    var _bargainAmountSum = {{ bargainAmountSum | safe }};//{"_id":{"site":"bitfinex","side":"buy","symbol":"eos#btc_1w"},"bargainAmount":400,"total":1600000,"sum":400}

    var _currentOperateLog;

    var _symbolAmounts = []; // { site: "",symbol: "",amount: 234,profit: 123, multipleWarehouse: 456, shortPosition: 567}

    
    $(function () {
        showReports();

        $("#datetimeStart").datetimepicker({
            format:'yyyy-mm-dd hh:ii',
            endDate:new Date(),
            todayBtn: true,
            // startView:2,//点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
            // minView:1,//插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
            minuteStep: 5,
            language:'zh-CN',
            autoclose:true
        // }).on("click",function(){
        //     $("#datetimeStart").datetimepicker("setEndDate",$("#datetimeEnd").val())
        });
        $("#datetimeEnd").datetimepicker({
            format:'yyyy-mm-dd hh:ii',
            endDate:new Date(),
            todayBtn: true,
            minuteStep: 5,
            // startView:2,//点开插件后显示的界面。0、小时1、天2、月3、年4、十年，默认值2
            // minView:1,//插件可以精确到那个时间，比如1的话就只能选择到天，不能选择小时了
            language:'zh-CN',
            autoclose:true
        }).on("click",function(){
        $("#datetimeEnd").datetimepicker("setStartDate",$("#datetimeStart").val())
        });


        $('select[name="sites"]').each(function(){
            $('<option/>').appendTo(this).val('').html('--请选择--');
            for(var i = 0; i < _business.sites.length;i++){
                var site = _business.sites[i];
                $('<option/>').appendTo(this).val(site).html(site);
            }
            
        });

        $('select[name="symbols"]').each(function(){
            $('<option/>').appendTo(this).val('').html('--请选择--');
            var group = $(this).attr('data-group');
            var site = $(this).val();
            var $element = $(w.format('select[name="symbols"][data-group="{0}"]',group));
            initSymbolItems($(this),site);
            
        });

        $('select[name="sites"]').change(function(){
            if($('select[name="sites"]').val()==''){
                $('#hide').hide();
                $('select[name="symbols"]').val('').html('--请选择--');
                
            }else{
                $('#hide').show();
                var group = $(this).attr('data-group');
                var site = $(this).val();
                if(!site){
                    return;
                }
                var $element = $(w.format('select[name="symbols"][data-group="{0}"]',group));
                initSymbolItems($element,site);
            } 
        });
        
        $('#btnSearch').click(function(){
            _symbolAmounts =[];
            $("#show").empty("");

            var site = $('#inquirysite').val();
            var symbol = $('#inquirysymbol').val();
            var status = $('#inquirystatus').val();
            var createdStart = $('#datetimeStart').val();
            var createdEnd = $('#datetimeEnd').val();

            var newParams = [
                { name:"site", value:site },
                { name:"symbol", value:symbol},
                { name:"status", value:status },
                { name:"createdStart", value:createdStart},
                { name:"createdEnd", value:createdEnd}
            ]

            $("#FlexiGrid_ContentTable").setNewExtParam(newParams);
            $("#FlexiGrid_ContentTable").flexReload();
         

        });

        initFlexiGrid();
        
    });
    
    function initFlexiGrid() { 
        var initData = {
            "page": 1,  //当前页
            "total": {{ total }},   //总页面数
            //"orders": {{ orders | safe }}
        };

        var option = {
            width: 0,
            height: 'auto',
            data: initData,
            autoPager: false,//分页菜单栏
            //autoToolBar: true,
            //colResizable: true,
            //mutilRowMessage: true,
            //showLoading: true,
            //showMessageOnRowClicked: true,
            url: '/admin/report/list',
            // colModel: [
            //     { display: "第三方id",name: "outerId",type: 0,visible: true,width: "80",sortable: true,align: "center" },
            //     { display: "交易品种", name: "symbol",type: 0,visible: true, width: "80", sortable: true,align: "center" },
            //     { display: "委托类型",name: "type", type: 0,visible: true,width: "80",sortable: true,align: "center" },
            //     { display: "委托状态",name: "status", type: 0,visible: true,width: "80",sortable: true,align: "center" },
            //     { display: "总数量",name: "amount", type: 0,visible: true,width: "100",sortable: true,align: "center" },
            //     { display: "已成交数量",name: "bargainAmount", type: 0,visible: true,width: "80",sortable: true,align: "center" },
            //     { display: "交易类型",name: "side", type: 0,visible: true,width: "80",sortable: true,align: "center" },
            //     { display: "创建时间",name: "created", type: 0,visible: true,width: "140",sortable: true,align: "center" },
            //     { display: "委托价格",name: "price", type: 0,visible: true,width: "100",sortable: true,align: "center" },
            //     { display: "平均成交价格",name: "avgPrice", type: 0,visible: true,width: "100",sortable: true,align: "center" },
            //     { display: "是否隐藏单",name: "hidden", type: 0,visible: true,width: "100",sortable: true,align: "center" }
            // ],
            //分页页码
            //onInited: flexiGridInited,
            //加载表格
            onPreLoad: flexiGridPreLoad,
            // onLoaded: flexiGridLoaded,
            // onCommand: flexiGridCommand,
            
            autoload: false,    //自动加载,改自动加载就会报错
            //columnsFixed: true,
            //checkCell: {
            //     showCheckAll: true,
            //     width: "25"
            // },
            //gridClass: "bbit-grid",
            bootStrapSupported: false,
            resizable: false,
            showTableToggleBtn: false,
            //usepager: true, //是否分页
            //useRp: true,    //是否可动态设置分页显示的结果数
            rp: 10,  //每页默认的结果数
            singleselected: false,
            nowrap: true,   //是否不换行
            showcheckbox: false,
            rpOptions: [10,20,30],  //可选择设定的每页结果数
            newp: 1,    //自定义翻页事件,定义刷新后第一页停留在哪个位置
            selectedonclick: false
        };
        
        $("#FlexiGrid_ContentTable").flexigrid(option);
        // $("#FlexiGrid_ContentTable").flexOptions(option).flexReload();
        var csrf = $('input[name="_csrf"]').val();
        $("#FlexiGrid_ContentTable").setNewExtParam([{name: "_csrf",value: csrf }]);   
    }

    // onToggoleLeft = function () {
    //     $('#FlexiGrid_ContentTable').fixGridWidth();
    // };

    //获取成交总数/平均价
    function showReports(){
        //总成交量
        var amount;
        //利润
        var profit = 0;
        //多仓
        var multipleWarehouse =0;
        //空仓
        var shortPosition = 0;
        for(var i = 0,l =_bargainAmountSum.length; i< l ;i++){

            amount = (_bargainAmountSum[i]._id.side=="buy"?_bargainAmountSum[i].bargainAmount:-_bargainAmountSum[i].bargainAmount);

            
            profit = (_bargainAmountSum[i].total/_bargainAmountSum[i].sum);

            var symbolItem = getItem(_bargainAmountSum[i]._id.site,_bargainAmountSum[i]._id.symbol); 
            symbolItem.amount += amount;
            symbolItem.profit += profit;

            if(amount > 0 ){
                symbolItem.multipleWarehouse += amount;
            } else{ 
                symbolItem.shortPosition += amountt;
            }
            
        }

        var arr= []; var result = {};var cc =[]; 
        for (var i = 0; i < _symbolAmounts.length; i++) {
            if(arr.indexOf(_symbolAmounts[i].symbol)==-1){
                    arr.push(_symbolAmounts[i].symbol);
            }
        }
        for (var i = 0; i < arr.length; i++) {
            var amount = 0;
            var profit = 0;
            var multipleWarehouse = 0;
            var shortPosition =0;
            result[arr[i]] = {
                    amount: 0,
                    multipleWarehouse : 0,
                    shortPosition : 0,
                    profit : 0,
                    data : []
            };
            // cc.push( result[arr[i]]);
            for (var j = 0; j < _symbolAmounts.length; j++) {
                if(_symbolAmounts[j].symbol==arr[i]){
                    amount += _symbolAmounts[j].amount;
                    multipleWarehouse += _symbolAmounts[j].multipleWarehouse;
                    shortPosition +=  _symbolAmounts[j].shortPosition;
                    profit +=  _symbolAmounts[j].profit;
                    result[arr[i]].amount = amount;
                    result[arr[i]].multipleWarehouse = multipleWarehouse;
                    result[arr[i]].shortPosition = shortPosition;
                    result[arr[i]].profit = profit;
                    result[arr[i]].data.push(_symbolAmounts[j]);
                }
                
            }
           
        }
        console.log(result);

        for(var key in result ){
            var html ="<div style='border:1px solid;width:50%;height:100%;float:left;'><table><thead style='border-bottom:1px dashed;'><tr><td>币种:<span style='color:red;'>"+key+ 
            "</span>,</td><td>总建仓:<span style='color:red;'>"+result[key].amount+
            "</span>,</td><td>总多仓:<span style='color:red;'>"+result[key].multipleWarehouse+
            "</span>,</td><td>总空仓:<span style='color:red;'>"+result[key].shortPosition+
            "</span>,</td><td>总利润:<span style='color:red;'>"+result[key].profit+
            "</span></td></tr></thead><tbody><tr><td colspan='5'>&nbsp;&nbsp;其中:</td></tr>";

        
        for(var i = 0; i<result[key].data.length;i++){
            html+="<tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;网站:<span style='color:red;'>"+result[key].data[i].site+
            "</span>,</td><td>建仓:<span style='color:red;'>"+result[key].data[i].amount+
            "</span>,</td><td>多仓:<span style='color:red;'>"+result[key].data[i].multipleWarehouse+
            "</span>,</td><td>空仓:<span style='color:red;'>"+result[key].data[i].shortPosition+
            "</span>,</td><td>利润:<span style='color:red;'>"+result[key].data[i].profit+"</span></td></tr>"; 

                
            }

            html+="</tbody></table></div>";

            $("#show").append(html);
       
    }  
        //console.log(result[key]);
        // console.log(result[key].data[i]);
        // console.log(result[key].data[i].amount);

    }

    //下拉框二级联动
    function initSymbolItems($element,site){
        $element.html('--请选择--');
        var symbols = [];
        for(var i = 0; i < _business.symbols.length;i++){
            if(_business.symbols[i].site == site){
                symbols = _business.symbols[i].symbols;
                break;
            }
        }

        for(var i = 0; i < symbols.length;i++){
            var symbol = symbols[i];
            $('<option/>').appendTo($element).val(symbol).html(symbol);
        }
    }

    
    //处理行情价格，split分割btc_1w
    function getItem(site,symbol){
        var t,
            coinsPair = symbol.split('_')[0];
        for(var i = 0,l = _symbolAmounts.length; i< l ;i++){
            if(_symbolAmounts[i].site == site && _symbolAmounts[i].symbol == coinsPair ){
                t = _symbolAmounts[i];
                break;
            }
        }

        if(!t){
            t = { site:site, symbol:coinsPair, amount: 0, profit: 0, multipleWarehouse: 0, shortPosition: 0 } 
            _symbolAmounts.push(t);
        }
      return t;  
    }
</script>
{% endblock %}
 

