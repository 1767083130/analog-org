{% extends "layouts/admin-master.html" %} 
{% block body %}
<div>
    
    <h3>委托列表:</h3>
    <div>
       
        <div style="width: 1040px; padding:2px; background-color: #C2DAFA;">  

            site:
            <select id="inquirysite" name="inquirysite">
                <option value="">请选择</option>
                <option value="bitfinex">bitfinex</option>
                <option value="okex">okex</option>
            </select>

            symbol: 
            <select id="inquirysymbol" name="inquirysymbol">  
                <option value="">请选择</option>
                <option value="eos#usd">eos#usd</option>
                <option value="btc#cny">btc#cny</option>
            </select>

            <span>
            起始时间<input type="text" id="origin"/>
            结束时间<input type="text" id="end"/>
            </span>
            <input type="button" id="btnSymbol" value="查询" /> 
        </div>
        <div id="FlexiGrid_ContentDiv" onLoad="goPage(1,10);">
            <table id="FlexiGrid_ContentTable" style="display: none">
            </table>
        </div>
        <div id="barcon" name="barcon"></div>
        <div name="customPager" id="flexiGridPager" for="FlexiGrid_ContentTable" style="padding-top: 4px; display: none"></div>
        <input type="hidden" name="_csrf" value="{{_csrf}}" />
        <a href="/admin/trade">返回</a>
    </div>
</div>

{% endblock %} {% block scripts %}
<script src="../js/jquery-1.8.2.js" type="text/javascript"></script>
<script src="../js/lib/jquery.flexigrid.js" type="text/javascript"></script>
<script src="../js/common.js" type="text/javascript"></script>

<script type="text/javascript">

    var _currentOperateLog;
    $(function () {
        $('#btnSymbol').click(function(){
            $("#FlexiGrid_ContentTable").setNewExtParam([
                { name:"symbol", value:$('#inquirysymbol').val() },
                { name:"site", value:$('#inquirysite').val() }
            ]);
            $("#FlexiGrid_ContentTable").flexReload();
        })

        initFlexiGrid();
        
    });

    function initFlexiGrid() { 
        var initData = {
            "page": 1,  //当前页
            "total": {{ total }},   //总页面数
            "orders": {{ orders | safe }}
        };

        var option = {
            width: 1044,
            height: 'auto',
            data: initData,
            autoPager: false,//分页菜单栏
            autoToolBar: true,
            colResizable: true,
            mutilRowMessage: true,
            showLoading: true,
            showMessageOnRowClicked: true,
            url: '/admin/trade/list',
            colModel: [
                { display: "第三方id",name: "outerId",type: 0,visible: true,width: "80",sortable: true,align: "center" },
                { display: "交易品种", name: "symbol",type: 0,visible: true, width: "80", sortable: true,align: "center" },
                { display: "委托类型",name: "type", type: 0,visible: true,width: "80",sortable: true,align: "center" },
                { display: "委托状态",name: "status", type: 0,visible: true,width: "80",sortable: true,align: "center" },
                { display: "已成交数量",name: "dealAmount", type: 0,visible: true,width: "80",sortable: true,align: "center" },
                { display: "总数量",name: "amount", type: 0,visible: true,width: "100",sortable: true,align: "center" },
                { display: "交易类型",name: "side", type: 0,visible: true,width: "80",sortable: true,align: "center" },
                { display: "时间戳",name: "created", type: 0,visible: true,width: "140",sortable: true,align: "center" },
                { display: "委托价格",name: "price", type: 0,visible: true,width: "100",sortable: true,align: "center" },
                { display: "平均成交价格",name: "avgPrice", type: 0,visible: true,width: "100",sortable: true,align: "center" },
                { display: "是否隐藏单",name: "hidden", type: 0,visible: true,width: "100",sortable: true,align: "center" }
            ],
            //分页页码
            onInited: flexiGridInited,
            //加载表格
            onPreLoad: flexiGridPreLoad,
            onLoaded: flexiGridLoaded,
            onCommand: flexiGridCommand,
            
            //onInquiry:flexiGridInquiry,
            //onSuccess:flexiGridWx,
            //onInit: flexiGridxx,
            

            autoload: false,    //自动加载,改自动加载就会报错
            columnsFixed: true,
            checkCell: {
                showCheckAll: true,
                width: "25"
            },
            gridClass: "bbit-grid",
            bootStrapSupported: false,
            resizable: false,
            showTableToggleBtn: false,
            usepager: true, //是否分页
            useRp: true,    //是否可动态设置分页显示的结果数
            rp: 10,  //每页默认的结果数
            singleselected: false,
            nowrap: true,   //是否不换行
            showcheckbox: false,
            rpOptions: [10,20,30],  //可选择设定的每页结果数
            newp: 1,    //自定义翻页事件,定义刷新后第一页停留在哪个位置
            selectedonclick: false
        };
        
        $("#FlexiGrid_ContentTable").flexigrid(option);
        // $("#FlexiGrid_ContentTable").flexOptions(option).flexReload();
        var csrf = $('input[name="_csrf"]').val();
        $("#FlexiGrid_ContentTable").setNewExtParam([{name: "_csrf",value: csrf }]);   
    }

    onToggoleLeft = function () {
        $('#FlexiGrid_ContentTable').fixGridWidth();
    };

    function flexiGridInquiry(){
        var option = {
            symbol:$("#symbol").val(),
            newp:1
        }

        $.ajax({
            type:"POST",
            url:'trade.js',
            data:option,
            dataType:'json'
        }).success(function(data){
            $("#FlexiGrid_ContentTable").flexOptions(data).flexReload(); 
            console.log(data);
        })

    }

    //分页页码
    function flexiGridInited(options) {
        debugger
        var option = { 
            pagerContainer: $("#flexiGridPager"),
            numDisplayEntries: 2, 
            numEdgeEntries: 2
        };
        $("#FlexiGrid_ContentTable").flexiGridPager(option);
        return options;
    }

    //这个很重要
    function flexiGridLoaded(options){
        $('a[name="manualOperate"]').click(function(){
            var orderId = $(this).attr("data-orderId");
            var operateLog;
            for(var i = 0; i < options.orders.length;i++){
                if(options.orders[i]._id == orderId){
                    operateLog = options.orders[i];
                    break;
                }
            }

            if(operateLog){
                _currentOperateLog = operateLog;
                $('#txtOperateAmount').val(operateLog.orgOperate.orderAmount)
            }
        });
    }

    //加载表格数据
    function flexiGridPreLoad(options){
        if(typeof options.orders == 'string'){
            options.orders = JSON.parse(options.orders);
        }

        var  data = {
            "page": options.page,
            "total": options.total,
            "dataType": "json",
            "rows": [],
            "orders": {}
        };

        var getLogOperateDesc = function(logOperate,isCurrent){
            var desc, operate = logOperate.orgOperate;
            if(operate.action == "transfer"){
                desc = w.format("从{0}网站转出{1}个{2}至{3}网站",operate.transferSource,operate.orderAmount,operate.symbol,operate.transferTarget);
            } else { //order 
                desc = w.format("从{0}网站{1}个{2}",operate.site,operate.side == 'sell' ? '卖出' : '买入',operate.symbol);
            }

            if(isCurrent && !operate.auto){
                desc += '<br/>';
                desc += w.format('<a href="#" name="manualOperate" data-logId="{0}">手动操作</a>',logOperate._id);
            }
            return desc;
        }

        var orders = options.orders || [];
        for(var i = 0; i < orders.length; i++){
            var order = orders[i];
            var row = {
                "id":order._id,
                "itemMessage": "",
                "cell":[
                    {
                        "cellHtml": order.outerId,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.symbol,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.type,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.status,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.dealAmount,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.amount,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.side,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.created ? w.dateformat(new Date(order.created),"yyyy-MM-dd hh:mm:ss") : '',
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.price,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.avgPrice,
                        "isReadOnly": true,
                        "attrs": []
                    },
                    {
                        "cellHtml": order.hidden,
                        "isReadOnly": true,
                        "attrs": []
                    }
                ],
                "attrs": []
            };
            data.rows.push(row);
        }
        return data;
    }

    function flexiGridCommand(sender, e) {
        var operateBtn = sender;
        var btnValue = $(operateBtn).attr("dataValue");
        var commandName = $(operateBtn).attr("commandName");
    }

    onToggoleLeft = function () {
        $('#refundRecordFlexiGrid_ContentTable').fixGridWidth();
    };

    function getTransferLogs() {
        var options = {
            pageIndex: 0,
            pageSize: 20,
            status: "wait",
            "_csrf": $('input[name="_csrf"]').val()
        };

        $.ajax({
            type: "POST",
            url: "/admin/trade/list",
            data: options,
            dataType: 'json'
        }).done(function (e) {

            if (e.isSuccess) {
                alert("成功！");
            }
            else {
                alert("系统错误，请稍后重试！");
            }
        }).fail(function (e) {
            alert("系统错误，请稍后重试！");
        });

    }

    function runTransferStep(){
        var sAmount = $('#txtOperateAmount').val();
        var amount = new Number(sAmount);
        if(isNaN(amount) || !isFinite(amount)){
            alert('请输入正确的金额');
            return;
        }

        var options = {
            logId: _currentOperateLog._id,
            amount
        };

        $.ajax({
            type: "POST",
            url: "/admin/trade/list",
            data: options,
            dataType: 'json'
        }).done(function (e) {

            if (e.isSuccess) {
                alert("成功！");
            }
            else {
                alert("系统错误，请稍后重试！");
            }
        }).fail(function (e) {
            alert("系统错误，请稍后重试！");
        });
    }

    function updateStepStatus() {
        var options = {
            orderId: 0,
            status: "wait"
        };

        $.ajax({
            type: "POST",
            url: "/admin/trade/list",
            data: options,
            dataType: 'json'
        }).done(function (e) {
            if (e.isSuccess) {
                alert("成功！");
            }
            else {
                alert("系统错误，请稍后重试！");
            }
        }).fail(function (e) {
            alert("系统错误，请稍后重试！");
        });
    }

         
</script>
{% endblock %}
 
