/*
Copyright 2012, KISSY UI Library v1.30rc
MIT Licensed
build time: Sep 12 15:29
*/
KISSY.add("mvc/collection",function(d,j,f,g){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={model:{value:f},models:{setter:function(a){this.remove(this.get("models"),{silent:1});this.add(a,{silent:1});return this.get("models")},value:[]},url:{value:""},comparator:{},sync:{value:function(){d.require("mvc").sync.apply(this,arguments)}},parse:{value:function(a){return a}}};d.extend(b,g,{sort:function(){var a=this.get("comparator");a&&this.get("models").sort(function(b,c){return a(b)-
a(c)})},toJSON:function(){return d.map(this.get("models"),function(a){return a.toJSON()})},add:function(a,b){var c=this,e=!0;if(d.isArray(a)){var k=[].concat(a);d.each(k,function(a){a=c._add(a,b);e=e&&a})}else e=c._add(a,b);return e},remove:function(a,b){var c=this;if(d.isArray(a)){var e=[].concat(a);d.each(e,function(a){c._remove(a,b)})}else a&&c._remove(a,b)},at:function(a){return this.get("models")[a]},_normModel:function(a){var b=!0;a instanceof f||(b=a,a=new (this.get("model")),b=a.set(b,{silent:1}));
return b&&a},load:function(a){var b=this,a=a||{},c=a.success;a.success=function(e){if(e){var k=b.get("parse").call(b,e);k&&b.set("models",k,a)}d.each(b.get("models"),function(a){a.__isModified=0});c&&c.apply(this,arguments)};b.get("sync").call(b,b,"read",a);return b},create:function(a,b){var c=this,b=b||{};if(a=this._normModel(a)){a.addToCollection(c);var e=b.success;b.success=function(){c.add(a,b);e&&e()};a.save(b)}return a},_add:function(a,b){if(a=this._normModel(a)){var b=b||{},c=this.get("models"),
e=this.get("comparator"),d=c.length;if(e)for(var f=e(a),d=0;d<c.length;d++){var i=e(c[d]);if(f<i)break}this.get("models").splice(d,0,a);a.addToCollection(this);b.silent||this.fire("add",{model:a})}return a},_remove:function(a,b){var b=b||{},c=d.indexOf(a,this.get("models"));-1!=c&&(this.get("models").splice(c,1),a.removeFromCollection(this));b.silent||this.fire("remove",{model:a})},getById:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.getId()===a)return e}return null},
getByCid:function(a){for(var b=this.get("models"),c=0;c<b.length;c++){var e=b[c];if(e.get("clientId")===a)return e}return null}});return b},{requires:["event","./model","base"]});
KISSY.add("mvc/model",function(d,j){function f(){f.superclass.constructor.apply(this,arguments);this.publish("*Change",{bubbles:1});this.collections={}}var g="idAttribute,clientId,urlRoot,url,parse,sync".split(",");d.extend(f,j,{addToCollection:function(b){this.collections[d.stamp(b)]=b;this.addTarget(b)},removeFromCollection:function(b){delete this.collections[d.stamp(b)];this.removeTarget(b)},getId:function(){return this.get(this.get("idAttribute"))},setId:function(b){return this.set(this.get("idAttribute"),
b)},setInternal:function(){this.__isModified=1;return f.superclass.setInternal.apply(this,arguments)},isNew:function(){return!this.getId()},isModified:function(){return!(!this.isNew()&&!this.__isModified)},destroy:function(b){var a=this,b=b||{},d=b.success;b.success=function(c){var e=a.collections;if(c){var k=a.get("parse").call(a,c);k&&a.set(k,b)}for(var f in e)e[f].remove(a,b),a.removeFromCollection(e[f]);a.fire("destroy");d&&d.apply(this,arguments)};!a.isNew()&&b["delete"]?a.get("sync").call(a,
a,"delete",b):(b.success(),b.complete&&b.complete());return a},load:function(b){var a=this,b=b||{},d=b.success;b.success=function(c){if(c){var e=a.get("parse").call(a,c);e&&a.set(e,b)}a.__isModified=0;d&&d.apply(this,arguments)};a.get("sync").call(a,a,"read",b);return a},save:function(b){var a=this,b=b||{},d=b.success;b.success=function(c){if(c){var e=a.get("parse").call(a,c);e&&a.set(e,b)}a.__isModified=0;d&&d.apply(this,arguments)};a.get("sync").call(a,a,a.isNew()?"create":"update",b);return a},
toJSON:function(){var b=this.getAttrVals();d.each(g,function(a){delete b[a]});return b}},{ATTRS:{idAttribute:{value:"id"},clientId:{valueFn:function(){return d.guid("mvc-client")}},url:{value:function(){var b,a,h=this.collections;for(b in h)if(h.hasOwnProperty(b)){a=h[b];break}b=a;var c;b=(b&&(c=b.get("url"))?d.isString(c)?c:c.call(b):c)||this.get("urlRoot");if(this.isNew())return b;b+="/"==b.charAt(b.length-1)?"":"/";return b+encodeURIComponent(this.getId())+"/"}},urlRoot:{value:""},sync:{value:function(){d.require("mvc").sync.apply(this,
arguments)}},parse:{value:function(b){return b}}}});return f},{requires:["base"]});KISSY.add("mvc",function(d,j,f,g,b,a){return{sync:a,Model:j,View:g,Collection:f,Router:b}},{requires:["mvc/model","mvc/collection","mvc/view","mvc/router","mvc/sync"]});
KISSY.add("mvc/router",function(d,j,f){function g(a){var b,c;for(c=0;c<a.length;c++)if(b=a.charAt(c),"\\"==b)c++;else if("("==b)return c;throw Error("impossible to not to get capture group in kissy mvc route");}function b(){return i.nativeHistory&&o?location.pathname.substr(i.urlRoot.length)+location.search:(new d.Uri(location.href)).getFragment().replace(/^!/,"")}function a(a){d.endsWith(a,"/")&&(a=a.substring(0,a.length-1));return a}function h(a){d.startsWith(a,"/")&&(a=a.substring(1));return"/"+
a}function c(b,c){b=a(b);c=a(c);return b==c}function e(){var a,c,e=0,h=-1,k="",f=-1,i=0,j="";a=new d.Uri(b());var l=0;c=a.clone();c.query.reset();c=c.toString();s(t,function(a){var b=0;s(a[p],function(d){var r=d.regStr,o=d.paramNames,m=-1,n,p=d.name,q=d.callback;if(n=c.match(d.reg)){n.shift();var t=function(){if(o){var a={};s(n,function(b,c){a[o[c]]=b});return a}return[].concat(n)},d=function(){k=r;f=m;i=q;l=t();e=a;j=p;h=n.length};if(n.length)if(r)m=g(r),m>f?d():m==f&&h>=n.length?n.length<h?d():
r.length>k.length&&d():e||d();else return d(),b=1,!1;else return d(),b=1,!1}});if(b)return!1});l&&(a=a.query.get(),i.apply(e,[l,a]),a={name:j,paths:l,query:a},e.fire("route:"+j,a),e.fire("route",a))}function k(a,b,c){var e=b,h=[];return d.isFunction(c)?(b=d.escapeRegExp(b),b=b.replace(u,function(a,b,c,d,e){h.push(c||e);if(c)return"([^/]+)";if(e)return"(.*)"}),{name:e,paramNames:h,reg:RegExp("^"+b+"$"),regStr:b,callback:c}):{name:e,reg:c.reg,callback:!d.isFunction(c.callback)&&d.isString(c.callback)?
a[c.callback]:c.callback}}function l(a){this[p]={};this.addRoutes(a.newVal)}function i(){i.superclass.constructor.apply(this,arguments);this.on("afterRoutesChange",l,this);l.call(this,{newVal:this.get("routes")});t.push(this)}var s=d.each,u=/(:([\w\d]+))|(\\\*([\w\d]+))/g,t=[],q=d.Env.host,m=q.history,o=!(!m||!m.pushState),p="__routerMap";i.ATTRS={routes:{}};d.extend(i,f,{addRoutes:function(a){var b=this;s(a,function(a,c){b[p][c]=k(b,c,!d.isFunction(a)&&d.isString(a)?b[a]:a)})}},{navigate:function(c,
d){b()!==c?i.nativeHistory&&o?(m.pushState({},"",location.protocol+"//"+location.host+a(i.urlRoot)+h(c)),e()):location.hash="!"+c:d&&d.triggerRoute&&e()},start:function(d){if(!i.__started){d=d||{};d.urlRoot=d.urlRoot||"";var f,k=d.nativeHistory,g=location.pathname,l=b(),p=location.hash.match(/#!.+/);f=i.urlRoot=d.urlRoot;if(i.nativeHistory=k)if(o)p&&c(g,f)&&(m.replaceState({},"",location.protocol+"//"+location.host+a(i.urlRoot)+h(l)),d.triggerRoute=1);else if(!c(g,f)){location.replace(a(f)+"/#!"+
l);return}setTimeout(function(){if(k&&o)j.on(q,"popstate",e);else j.on(q,"hashchange",e),d.triggerRoute=1;d.triggerRoute&&e();d.success&&d.success()},100);i.__started=1}}});return i},{requires:["event","base"]});
KISSY.add("mvc/sync",function(d,j,f){var g={create:"POST",update:"POST","delete":"POST",read:"GET"};return function(b,a,h){var h=d.merge({type:g[a],dataType:"json"},h),c=h.data=h.data||{};c._method=a;h.url||(h.url=d.isString(b.get("url"))?b.get("url"):b.get("url").call(b));if("create"==a||"update"==a)c.model=f.stringify(b.toJSON());return j(h)}},{requires:["ajax","json"]});
KISSY.add("mvc/view",function(d,j,f){function g(){g.superclass.constructor.apply(this,arguments);var a;(a=this.get("events"))&&this._afterEventsChange({newVal:a})}var b=j.all;g.ATTRS={el:{value:"<div />",getter:function(a){d.isString(a)&&(a=b(a),this.setInternal("el",a));return a}},events:{}};d.extend(g,f,{_afterEventsChange:function(a){var b=a.prevVal;b&&this._removeEvents(b);this._addEvents(a.newVal)},_removeEvents:function(a){var b=this.get("el"),c;for(c in a){var e=a[c],f;for(f in e){var g=d.isString(e[f])?
this[e[f]]:e[f];b.undelegate(f,c,g,this)}}},_addEvents:function(a){var b=this.get("el"),c;for(c in a){var e=a[c],f;for(f in e){var g=d.isString(e[f])?this[e[f]]:e[f];b.delegate(f,c,g,this)}}},render:function(){return this},destroy:function(){this.get("el").remove()}});return g},{requires:["node","base"]});
