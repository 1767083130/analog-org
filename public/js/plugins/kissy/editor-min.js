/*
Copyright 2012, KISSY UI Library v1.30rc
MIT Licensed
build time: Nov 19 17:17
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(e,m,u){m=u.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:m.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(e){return this._setData(e)}},formatData:{getter:function(){return this._getData(1)},setter:function(e){return this._setData(e)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});m.HTML_PARSER={textarea:function(e){return e.one("."+this.get("prefixCls")+"editor-textarea")}};e.mix(m,e.EventTarget);return KISSY.Editor=m},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(e,m,u,q){function r(a){this.editor=a;this._init()}function i(a){if(k.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),d;if(b.getType()==q.SELECTION_ELEMENT&&(d=b.getSelectedElement())){var g=b.getRanges()[0],c=f(a.get("document")[0].createTextNode(""));c.insertBefore(d);g.setStartBefore(c);g.setEndAfter(d);b.selectRanges([g]);setTimeout(function(){d.parent()&&(c.remove(),b.selectElement(d))},0)}}}var f=e.all,k=e.UA,n=m.RANGE,o=e.Event;
e.augment(r,{_init:function(){var a=this.editor,h=a.get("document")[0].body;o.on(h,k.ie?"beforepaste":"paste",this._paste,this);o.on(h,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new v("copy"));a.addCommand("cut",new v("cut"));a.addCommand("paste",new v("paste"))},_paste:function(){if(!b){var a=this.editor,h=a.get("document")[0];if(!h.getElementById("ke_pastebin")){var d=a.getSelection(),g=new u(h),c=f(k.webkit?"<body></body>":"<div></div>",null,h);c.attr("id",
"ke_pastebin");k.webkit&&c[0].appendChild(h.createTextNode("\u00a0"));h.body.appendChild(c[0]);c.css({position:"absolute",top:d.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});c.css("left","-1000px");var l=d.createBookmarks();g.setStartAt(c,n.POSITION_AFTER_START);g.setEndAt(c,n.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var b;c=k.webkit&&(b=c.first())&&b.hasClass("Apple-style-span")?b:c;d.selectBookmarks(l);c.remove();var g=c.html();if(g=e.trim(g.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))b=a.fire("paste",{html:g,holder:c}),void 0!==b&&(g=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(g)?e.use("editor/plugin/word-filter/dynamic/",function(c,d){a.insertHtml(d.toDataFormat(g,a))}):a.insertHtml(g)},0)}}}});var x=function(a,b){var d=a.get("document")[0],g=f(d.body),c=!1,l=function(){c=!0};g.on(b,l);(7<k.ie?d:d.selection.createRange()).execCommand(b);g.detach(b,l);return c},p=k.ie?function(a,b){return x(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(d){return!1}},
y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},v=function(a){this.type=a};v.prototype={exec:function(a){"cut"==this.type&&i(a);(a=p(a,this.type))||alert(y[this.type]);return a}};var j={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(a){a.docReady(function(){new r(a)});var b={copy:1,cut:1,paste:1};a.on("contextmenu",function(d){d=d.contextmenu;if(!d.__copy_fix){d.__copy_fix=
1;for(var g in b)b.hasOwnProperty(g)&&d.addChild({xclass:"menuitem",content:j[g],value:g});d.on("click",function(c){var d=c.target.get("value");b[d]&&(this.hide(),setTimeout(function(){a.execCommand(d)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.config("modules",{"editor/plugin/heading/cmd":{requires:["editor"]},"editor/plugin/page-break/index":{requires:["editor","editor/plugin/fake-objects/"]},"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/image/dialog":{requires:["ajax","editor","editor/plugin/overlay/","tabs","editor/plugin/menubutton/"]},"editor/plugin/underline/index":{requires:["editor","editor/plugin/font/ui",
"editor/plugin/underline/cmd"]},"editor/plugin/maximize/cmd":{requires:["editor"]},"editor/plugin/contextmenu/index":{requires:["editor","menu","editor/plugin/focus-fix/"]},"editor/plugin/heading/index":{requires:["editor","editor/plugin/heading/cmd"]},"editor/plugin/drag-upload/index":{requires:["editor"]},"editor/plugin/color/cmd":{requires:["editor"]},"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/code/index":{requires:["editor",
"editor/plugin/dialog-loader/"]},"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/unordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]},"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/italic/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]},"editor/plugin/remove-format/cmd":{requires:["editor"]},"editor/plugin/font-size/index":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]},"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/table/index":{requires:["editor","editor/plugin/dialog-loader/","editor/plugin/contextmenu/"]},"editor/plugin/word-filter/dynamic/index":{requires:["htmlparser"]},"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/resize/index":{requires:["editor","dd"]},"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog",
"editor/plugin/menubutton/"]},"editor/plugin/focus-fix/index":{requires:["editor"]},"editor/plugin/xiami-music/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/maximize/index":{requires:["editor","editor/plugin/maximize/cmd"]},"editor/plugin/color/color-picker/dialog":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/smiley/index":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/separator/index":{requires:["editor"]},
"editor/plugin/video/index":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/baseClass","editor/plugin/fake-objects/"]},"editor/plugin/multiple-upload/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/menubutton/index":{requires:["editor","menubutton"]},"editor/plugin/flash/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils",
"editor/plugin/fake-objects/"]},"editor/plugin/overlay/index":{requires:["editor","overlay","editor/plugin/focus-fix/","dd"]},"editor/plugin/link/utils":{requires:["editor"]},"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/button/index":{requires:["editor","button"]},"editor/plugin/checkbox-source-area/index":{requires:["editor"]},"editor/plugin/strike-through/index":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/strike-through/cmd"]},"editor/plugin/fore-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]},"editor/plugin/flash-bridge/index":{requires:["editor","editor/plugin/flash-common/utils"]},"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/table/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/justify-utils/cmd":{requires:["editor"]},"editor/plugin/undo/index":{requires:["editor",
"editor/plugin/undo/btn","editor/plugin/undo/cmd"]},"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/image/index":{requires:["editor","editor/plugin/button/","editor/plugin/bubble/","editor/plugin/contextmenu/","editor/plugin/dialog-loader/"]},"editor/plugin/dent-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]},"editor/plugin/list-utils/index":{requires:["editor"]},
"editor/plugin/dialog-loader/index":{requires:["overlay","editor"]},"editor/plugin/font-family/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]},"editor/plugin/undo/cmd":{requires:["editor"]},"editor/plugin/indent/index":{requires:["editor","editor/plugin/indent/cmd"]},"editor/plugin/font/cmd":{requires:["editor"]},"editor/plugin/ordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]},"editor/plugin/color/btn":{requires:["editor",
"editor/plugin/button/","editor/plugin/overlay/","editor/plugin/dialog-loader/"]},"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/local-storage/index":{requires:["editor","overlay","editor/plugin/flash-bridge/"]},"editor/plugin/bubble/index":{requires:["overlay","editor"]},"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/bold/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]},"editor/plugin/back-color/index":{requires:["editor",
"editor/plugin/color/btn","editor/plugin/back-color/cmd"]},"editor/plugin/draft/index":{requires:["editor","editor/plugin/local-storage/","overlay","editor/plugin/menubutton/"]},"editor/plugin/link/index":{requires:["editor","editor/plugin/bubble/","editor/plugin/link/utils","editor/plugin/dialog-loader/","editor/plugin/button/"]},"editor/plugin/remove-format/index":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button/"]},"editor/plugin/font/ui":{requires:["editor","editor/plugin/button/",
"editor/plugin/menubutton/"]},"editor/plugin/element-path/index":{requires:["editor"]},"editor/plugin/source-area/index":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-right/index":{requires:["editor","editor/plugin/justify-right/cmd"]},"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-left/index":{requires:["editor","editor/plugin/justify-left/cmd"]},"editor/plugin/outdent/index":{requires:["editor","editor/plugin/outdent/cmd"]},
"editor/plugin/fake-objects/index":{requires:["editor"]},"editor/plugin/link/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/link/utils"]},"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/multiple-upload/dialog":{requires:["editor","editor/plugin/progressbar/","editor/plugin/overlay/","editor/plugin/flash-bridge/","editor/plugin/local-storage/"]},"editor/plugin/code/dialog":{requires:["editor",
"editor/plugin/overlay/","menubutton"]},"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/flash-common/baseClass":{requires:["editor","editor/plugin/contextmenu/","editor/plugin/bubble/","editor/plugin/dialog-loader/","editor/plugin/flash-common/utils"]},"editor/plugin/justify-center/index":{requires:["editor","editor/plugin/justify-center/cmd"]},"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});
KISSY.add("editor/core/dom",function(e,m,u){function q(b,a){var h=b[a?"next":"prev"](r,1);if(h&&h[0].nodeType==k.ELEMENT_NODE){for(var d=[];h.attr("_ke_bookmark")||h._4e_isEmptyInlineRemovable(r);)if(d.push(h),h=a?h.next(r,1):h.prev(r,1),!h)return;if(b._4e_isIdentical(h,r)){for(var g=new o(a?b[0].lastChild:b[0].firstChild);d.length;)d.shift()._4e_move(b,!a,r);h._4e_moveChildren(b,!a,r);h.remove();g[0]&&g[0].nodeType==k.ELEMENT_NODE&&g._4e_mergeSiblings()}}}var r=r,i=m.XHTML_DTD,f=e.DOM,k=f.NodeType,
n=e.UA,o=e.Node,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};m.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var p=m.POSITION,y={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},v={hr:1},j=function(b){return b&&(b[0]||b)};u.injectDom({_4e_sameLevel:function(b,a){var a=j(a),h=b.parentNode;return h&&h==a.parentNode},_4e_isBlockBoundary:function(b,a){var h=e.merge(v,a);return!(!y[f.css(b,"display")]&&!h[f.nodeName(b)])},_4e_index:function(b,a){for(var h=b.parentNode.childNodes,d,g=-1,c=0;c<h.length;c++)if(d=h[c],!a||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(g++,d===b)return g;return-1},_4e_move:function(b,
a,h){a=j(a);h?a.insertBefore(b,a.firstChild):a.appendChild(b)},_4e_isIdentical:function(b,a){if(!a)return!1;a=j(a);if(f.nodeName(b)!=f.nodeName(a))return!1;var h=b.attributes,d=a.attributes,g=h.length,c=d.length;if(g!=c)return!1;for(var l=0;l<g;l++){var t=h[l],e=t.name;if(t.specified&&f.attr(b,e)!=f.attr(a,e))return!1}if(8>u.ieEngine)for(l=0;l<c;l++)if(t=d[l],e=t.name,t.specified&&f.attr(b,e)!=f.attr(a,e))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){if(!i.$removeEmpty[f.nodeName(b)])return!1;
for(var b=b.childNodes,a=0,h=b.length;a<h;a++){var d=b[a],g=d.nodeType;if(!(g==k.ELEMENT_NODE&&d.getAttribute("_ke_bookmark"))&&(g==k.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(d)||g==f.NodeType.TEXT_NODE&&e.trim(d.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,a,h){a=j(a);if(b!=a)if(h)for(;h=b.lastChild;)a.insertBefore(b.removeChild(h),a.firstChild);else for(;h=b.firstChild;)a.appendChild(b.removeChild(h))},_4e_mergeSiblings:function(b){b=new o(b);x[b.nodeName()]&&(q(b,!0),q(b))},_4e_splitText:function(b,
a){var h=b.ownerDocument;if(b.nodeType==f.NodeType.TEXT_NODE){if(n.ie&&a==b.nodeValue.length){var d=h.createTextNode("");f.insertAfter(d,b);return d}d=b.splitText(a);h.documentMode&&(h=h.createTextNode(""),f.insertAfter(h,d),f.remove(h));return d}},_4e_parents:function(b,a){var h=[];h.__IS_NODELIST=1;do h[a?"push":"unshift"](b);while(b=b.parentNode);return h},_4e_nextSourceNode:function(b,a,h,d){if(d&&!d.call)var g=j(d),d=function(a){return a!==g};var a=!a&&b.firstChild,c=b;if(!a){if(b.nodeType==
k.ELEMENT_NODE&&d&&!1===d(b,!0))return null;a=b.nextSibling}for(;!a&&(c=c.parentNode);){if(d&&!1===d(c,!0))return null;a=c.nextSibling}return!a||d&&!1===d(a)?null:h&&h!=a.nodeType?f._4e_nextSourceNode(a,!1,h,d):a},_4e_previousSourceNode:function(b,a,h,d){if(d&&!d.call)var g=j(d),d=function(a){return a!==g};var a=!a&&b.lastChild,c=b;if(!a){if(b.nodeType==k.ELEMENT_NODE&&d&&!1===d(b,!0))return null;a=b.previousSibling}for(;!a&&(c=c.parentNode);){if(d&&!1===d(c,!0))return null;a=c.previousSibling}return!a||
d&&!1===d(a)?null:h&&a.nodeType!=h?f._4e_previousSourceNode(a,!1,h,d):a},_4e_commonAncestor:function(b,a){a=j(a);if(b===a)return b;if(f.contains(a,b))return a;var h=b;do if(f.contains(h,a))return h;while(h=h.parentNode);return null},_4e_hasAttributes:9>u.ieEngine?function(b){for(var a=b.attributes,h=0;h<a.length;h++){var d=a[h];switch(d.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(d.specified)return!0}}return!1}:function(b){n.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},
_4e_position:function(b,a){var h=j(a);if(b.compareDocumentPosition)return b.compareDocumentPosition(h);if(b==h)return p.POSITION_IDENTICAL;if(b.nodeType==k.ELEMENT_NODE&&h.nodeType==k.ELEMENT_NODE){if(f.contains(b,h))return p.POSITION_CONTAINS+p.POSITION_PRECEDING;if(f.contains(h,b))return p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>h.sourceIndex?p.POSITION_DISCONNECTED:b.sourceIndex<h.sourceIndex?p.POSITION_PRECEDING:p.POSITION_FOLLOWING}for(var d=
f._4e_address(b),h=f._4e_address(h),g=Math.min(d.length,h.length),c=0;c<=g-1;c++)if(d[c]!=h[c])return d[c]<h[c]?p.POSITION_PRECEDING:p.POSITION_FOLLOWING;return d.length<h.length?p.POSITION_CONTAINS+p.POSITION_PRECEDING:p.POSITION_IS_CONTAINED+p.POSITION_FOLLOWING},_4e_address:function(b,a){for(var h=[],d=b.ownerDocument.documentElement,g=b;g&&g!=d;)h.unshift(f._4e_index(g,a)),g=g.parentNode;return h},_4e_remove:function(b,a){var h=b.parentNode;if(h){if(a)for(var d;d=b.firstChild;)h.insertBefore(b.removeChild(d),
b);h.removeChild(b)}return b},_4e_trim:function(b){f._4e_ltrim(b);f._4e_rtrim(b)},_4e_ltrim:function(b){for(var a;a=b.firstChild;){if(a.nodeType==f.NodeType.TEXT_NODE){var h=u.ltrim(a.nodeValue),d=a.nodeValue.length;if(h)h.length<d&&(f._4e_splitText(a,d-h.length),b.removeChild(b.firstChild));else{b.removeChild(a);continue}}break}},_4e_rtrim:function(b){for(var a;a=b.lastChild;){if(a.type==f.NodeType.TEXT_NODE){var h=u.rtrim(a.nodeValue),d=a.nodeValue.length;if(h)h.length<d&&(f._4e_splitText(a,h.length),
b.removeChild(b.lastChild));else{b.removeChild(a);continue}}break}!n.ie&&!n.opera&&(a=b.lastChild)&&1==a.nodeType&&"br"==f.nodeName(a)&&b.removeChild(a)},_4e_appendBogus:function(b){for(var a=b.lastChild;a&&a.nodeType==f.NodeType.TEXT_NODE&&!e.trim(a.nodeValue);)a=a.previousSibling;if(!a||a.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(a))a=n.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),n.gecko&&a.setAttribute("type","_moz"),b.appendChild(a)},_4e_outerHtml:function(b){if(b.outerHTML)return b.outerHTML.replace(/<\?[^>]*>/,
"");var a=b.ownerDocument.createElement("div");a.appendChild(b.cloneNode(!0));return a.innerHTML},_4e_setMarker:function(b,a,h,d){var b=new o(b),g=b.data("list_marker_id")||b.data("list_marker_id",e.guid()).data("list_marker_id"),c=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");a[g]=b;c[h]=1;return b.data(h,d)},_4e_clearMarkers:function(b,a,h){var b=new o(b),d=b.data("list_marker_names"),g=b.data("list_marker_id"),c;for(c in d)d.hasOwnProperty(c)&&b.removeData(c);
b.removeData("list_marker_names");h&&(b.removeData("list_marker_id"),delete a[g])},_4e_copyAttributes:function(b,a,h){for(var a=new o(a),d=b.attributes,h=h||{},g=0;g<d.length;g++){var c=d[g],l=c.name.toLowerCase(),t;if(!(l in h))if("checked"==l&&(t=f.attr(b,l)))a.attr(l,t);else if(c.specified||n.ie&&c.value&&"value"==l)t=f.attr(b,l),null===t&&(t=c.nodeValue),a.attr(l,t)}""!==b.style.cssText&&(a[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){b=f.nodeName(b);return(b=!i.$nonEditable[b]&&
(i[b]||i.span))&&b["#text"]},_4e_getByAddress:function(b,a,h){for(var b=b.documentElement,d=0;b&&d<a.length;d++){var g=a[d];if(h)for(var c=-1,l=0;l<b.childNodes.length;l++){var t=b.childNodes[l];if(!(!0===h&&3==t.nodeType&&t.previousSibling&&3==t.previousSibling.nodeType)&&(c++,c==g)){b=t;break}}else b=b.childNodes[g]}return b}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(e){function m(f){1>arguments.length||(this.range=f,this.forceBrBreak=q,this.enlargeBr=u,this.enforceRealBlocks=q,this._||(this._={}))}var u=!0,q=!1,r=e.Editor,i=e.UA,f=r.Walker,k=r.Range,n=r.RANGE,o=r.ElementPath,x=e.Node,p=e.DOM,y=/^[\r\n\t ]*$/;e.augment(m,{getNextParagraph:function(m){var j,b,a,h,d;if(!this._.lastNode){b=this.range.clone();b.shrink(n.SHRINK_ELEMENT,u);b.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var g=new f(b),c=f.bookmark(u,u);g.evaluator=c;this._.nextNode=g.next();g=new f(b);g.evaluator=c;g=g.previous();this._.lastNode=g._4e_nextSourceNode(u);this._.lastNode&&this._.lastNode[0].nodeType==p.NodeType.TEXT_NODE&&!e.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(c=new k(b.document),c.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),c.checkEndOfBlock()&&(c=new o(c.endContainer),this._.lastNode=(c.block||c.blockLimit)._4e_nextSourceNode(u)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(b.document.createTextNode("")),p.insertAfter(this._.lastNode[0],g[0]));b=null}c=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;c;){var l=q,t=c[0].nodeType!=p.NodeType.ELEMENT_NODE,C=q;if(t)c[0].nodeType==p.NodeType.TEXT_NODE&&y.test(c[0].nodeValue)&&(t=q);else{var D=c.nodeName();if(c._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==D)t=u;else if(!b&&!c[0].childNodes.length&&"hr"!=D){j=c;a=c.equals(g);break}b&&(b.setEndAt(c,n.POSITION_BEFORE_START),
"br"!=D&&(this._.nextNode=c));l=u}else{if(c[0].firstChild){b||(b=new k(this.range.document),b.setStartAt(c,n.POSITION_BEFORE_START));c=new x(c[0].firstChild);continue}t=u}}t&&!b&&(b=new k(this.range.document),b.setStartAt(c,n.POSITION_BEFORE_START));a=(!l||t)&&c.equals(g);if(b&&!l)for(;!c[0].nextSibling&&!a;){D=c.parent();if(D._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=u;a||D.equals(g);break}c=D;t=u;a=c.equals(g);C=u}t&&b.setEndAt(c,n.POSITION_AFTER_END);c=c._4e_nextSourceNode(C,null,g);if((a=
!c)||l&&b)break}if(!j){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;j=new o(b.startContainer);c=j.blockLimit;l={div:1,th:1,td:1};j=j.block;if((!j||!j[0])&&!this.enforceRealBlocks&&l[c.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())j=c;else if(!j||this.enforceRealBlocks&&"li"==j.nodeName())j=new x(this.range.document.createElement(m||"p")),j[0].appendChild(b.extractContents()),j._4e_trim(),b.insertNode(j),h=d=u;else if("li"!=j.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())j=j.clone(q),j[0].appendChild(b.extractContents()),j._4e_trim(),d=b.splitBlock(),h=!d.wasStartOfBlock,d=!d.wasEndOfBlock,b.insertNode(j)}else a||(this._.nextNode=j.equals(g)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(u,null,g))}h&&(b=new x(j[0].previousSibling),b[0]&&b[0].nodeType==p.NodeType.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==p.nodeName(b[0].lastChild)&&p._4e_remove(b[0].lastChild)));d&&(b=f.bookmark(q,u),h=new x(j[0].lastChild),
h[0]&&h[0].nodeType==p.NodeType.ELEMENT_NODE&&"br"==h.nodeName()&&(i.ie||h.prev(b,1)||h.next(b,1))&&h.remove());this._.nextNode||(this._.nextNode=a||j.equals(g)?null:j._4e_nextSourceNode(u,null,g));return j}});k.prototype.createIterator=function(){return new m(this)};return m},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor",function(e,m,u,q,r,i,f,k,n,o){function x(a,c){var s=a.body;E(function(){a.designMode="on";setTimeout(function(){a.designMode="off";s.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";t.attr(s,"contentEditable",d);t.attr(s,"contentEditable",b);!c&&x(a,1)})}function p(a){a.get("iframe");var b=a.get("textarea")[0],s=a.get("window")[0],g=a.get("document")[0];c.webkit&&(A.on(g,"click",function(a){var c=new D(a.target);e.inArray(c.nodeName(),
["input","select"])&&a.preventDefault()}),A.on(g,"mouseup",function(a){var c=new D(a.target);e.inArray(c.nodeName(),["input","textarea"])&&a.preventDefault()}));if(c.gecko||l||c.opera){var w;w=(new D('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);w.on("focus",function(){a.focus()});a.activateGecko=function(){c.gecko&&a.__iframeFocus&&w[0].focus()};a.on("destroy",function(){w.detach();w.remove()})}A.on(s,"focus",function(){c.gecko?x(g,d):c.opera&&
g.body.focus();a.notifySelectionChange()});if(c.gecko)A.on(g,"mousedown",function(){a.__iframeFocus||x(g,d)});if(l&&(A.on(g,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var b=a.getSelection(),d=b.getSelectedElement();if(d){a.execCommand("save");var s=b.getRanges()[0].createBookmark();d.remove();b.selectBookmarks([s]);a.execCommand("save");c.preventDefault()}}}),"CSS1Compat"==g.compatMode)){var z={33:1,34:1};A.on(g,"keydown",function(c){c.keyCode in z&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(c.webkit)A.on(g,"mousedown",function(c){c=new D(c.target);e.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(c)});if(c.gecko)A.on(g,"dragstart",function(a){var c=new D(a.target);c.nodeName()==="img"&&/ke_/.test(c[0].className)&&a.preventDefault()});q.add(a)}function y(a,c,b,d){var l="",w,z=u.debugUrl("theme/editor-iframe.css");for(w=0;w<b.length;w++)l+=e.substitute('<link href="{href}" rel="stylesheet" />',{href:b[w]});return e.substitute(s,{doctype:8===
g.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:z,style:c,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(t.isCustomDomain()?'document.domain="'+g.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function v(a,c){function b(){z=w.document;a.setInternal("document",new D(z));a.setInternal("window",new D(w));d.detach();z.open("text/html","replace");z.write(s);z.close()}var d=a.get("iframe"),s=y(a._UUID,a.get("customStyle"),
a.get("customLink"),c),g=d[0],w=g.contentWindow,z;d.__loaded=1;try{z=w.document}catch(h){if(g.src=g.src,7>l){setTimeout(b,10);return}}b()}function j(a,b){var d=t.getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new D(e.substitute(z,{iframeSrc:d})),s=a.get("textarea");s.hasAttr("tabindex")&&d.attr("tabIndex",c.webkit?-1:s.attr("tabIndex"));s.parent().prepend(d);a.set("iframe",d);a.__docReady=0;if(c.gecko&&!d.__loaded)d.on("load",function(){v(a,b)},a);else v(a,b)}var b=!0,a=a,h=e.all,d=!1,g=document,
c=e.UA,l=c.ie,t=e.DOM,C=t.NodeType,D=e.Node,A=e.Event,E=u.tryThese,s="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor' >{data}{script}</body></html>",z='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',w='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+(c.mobile?
'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+"></div><div class='{prefixCls}editor-status'></div>";e.mix(m,{SOURCE_MODE:0,WYSIWYG_MODE:1});var I=m.WYSIWYG_MODE;e.augment(m,{createDom:function(){var a,c=this.get("prefixCls"),d=this.get("textarea"),b;d?(this.set("textarea",d=h(d)),d[0].parentNode&&d[0].parentNode.removeChild(d[0])):this.set("textarea",d=h("<textarea class='"+c+"-editor-textarea'></textarea>"));b=this.get("el");b.html(e.substitute(w,{prefixCls:c}));a=b.one(e.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=e.guid();this.set({toolBarEl:b.one(e.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:b.one(e.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");a.append(d);q.register(this)},renderUI:function(){f.init(this);k.init(this);n.init(this);o.init(this)},bindUI:function(){function a(){c.detach("docReady",a);if(c.get("focused"))c.focus();else{var d=c.getSelection();d&&d.removeAllRanges()}}var c=this,
d,b=c.get("prefixCls"),s=c.get("textarea");if(c.get("attachForm")&&(d=s[0].form))A.on(d,"submit",c.sync,c),c.on("destroy",function(){A.detach(d,"submit",c.sync,c)});c.on("docReady",a);c.on("blur",function(){c.get("el").removeClass(b+"editor-focused")});c.on("focus",function(){c.get("el").addClass(b+"editor-focused")})},_uiSetHeight:function(a){var c=this.get("textarea"),d=this.get("toolBarEl"),b=this.get("statusBarEl"),a=parseInt(a,10),a=a-((d&&d.outerHeight()||0)+(b&&b.outerHeight()||0));c.parent().css("height",
a);c.css("height",a)},_uiSetMode:function(a){var c=this,d,b=c.get("rendered"),s=c.get("iframe"),g=c.get("textarea");a==I?(b&&c.execCommand("save"),c.on("docReady",d=function(){b&&c.execCommand("save");c.detach("docReady",d)}),c._setData(g.val()),c.fire("wysiwygMode")):(s&&(g.val(c._getData(1,I)),s.hide()),g.show(),c.fire("sourceMode"))},_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],c=this.get("window");this.sync();q.remove(this);A.remove([a,
a.documentElement,a.body,c[0]]);e.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,c){this.__controls[a]=c},showDialog:function(a,c){var a=a+"/dialog",d=this.__controls[a];d.show(c);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,dialogName:a})},addCommand:function(a,c){this.__commands[a]=c},hasCommand:function(a){return this.__commands[a]},
execCommand:function(a){var c=this.__commands[a],d=e.makeArray(arguments);d.shift();d.unshift(this);if(c)return c.exec.apply(c,d)},queryCommandValue:function(a){return this.execCommand(u.getQueryCmd(a))},_getData:function(c,d){var b=this.htmlDataProcessor,s;d==a&&(d=this.get("mode"));s=d==I?this.get("document")[0].body.innerHTML:b.toDataFormat(this.get("textarea").val());s=c?b.toHtml(s):b.toServer(s);s=e.trim(s);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(s)&&(s="");return s},_setData:function(a){var c,
d=a;if(this.get("mode")!=I)this.get("textarea").val(a);else{if(c=this.htmlDataProcessor)d=c.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");c=this.get("window")[0];var b=this.get("document")[0];A.remove([b,b.documentElement,b.body,c]);a.remove()}j(this,d)}},sync:function(){this.get("textarea").val(this.get("data"))},getDocHtml:function(){return y(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return m.Selection.getSelection(this.get("document")[0])},
focus:function(){var a=this.get("window");if(a){var d=this.get("document")[0],a=a[0];c.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{d.body.focus()}catch(b){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,c){var d=this.get("customStyle")||"",d=d+("\n"+a);this.set("customStyle",d);t.addStyleSheet(this.get("window"),d,c)},removeCustomStyle:function(a){t.remove(t.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var c=
this.get("customLink")||[],d=this.get("document")[0];c.push(a);this.set("customLink",c);c=d.createElement("link");c.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(c);c.href=a},removeCustomLink:function(a){for(var c=this.get("document")[0],c=t.query("link",c),d=0;d<c.length;d++)t.attr(c[d],"href")==a&&t.remove(c[d]);c=this.get("customLink")||[];a=e.indexOf(a,c);-1!=a&&c.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=
this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var c=a.getSelection();if(c&&!c.isInvalid){var d=c.getStartElement(),b=new m.ElementPath(d);if(!a.__previousPath||!a.__previousPath.compare(b))a.__previousPath=b,a.fire("selectionChange",{selection:c,path:b,element:d})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(c){if(this.get("mode")===I){this.focus();
var d,s=c.nodeName(),g=m.XHTML_DTD,l=g.$block[s],w=m.RANGE,z=(s=this.getSelection())&&s.getRanges(),h,t,f;if(z&&0!=z.length){this.execCommand("save");for(t=z.length-1;0<=t;t--)h=z[t],d=!t&&c||c.clone(b),h.insertNodeByDtd(d),f||(f=d);if(f)return h.moveToPosition(f,w.POSITION_AFTER_END),l&&(c=m.Walker.whitespaces(!0),(c=(f=f.next(c,1))&&f[0].nodeType==C.ELEMENT_NODE&&f.nodeName())&&g.$block[c]&&g[c]["#text"]&&h.moveToElementEditablePosition(f)),s.selectRanges([h]),this.focus(),d&&1==d[0].nodeType&&
d.scrollIntoView(a,!1),G.call(this),d}}},insertHtml:function(c,b){var s=this,g,w=s.get("document")[0];if(s.get("mode")===I){if(g=s.htmlDataProcessor)c=g.toDataFormat(c,b);s.focus();s.execCommand("save");if(l){g=w.selection;"Control"==g.type&&g.clear();try{g.createRange().pasteHTML(c)}catch(z){}}else try{w.execCommand("inserthtml",d,c)}catch(h){setTimeout(function(){if(0==s.getSelection().getRanges().length){var b=new m.Range(w),g=t.first(w.body,function(a){return 1==a.nodeType&&"br"!=t.nodeName(a)});
g||(g=new D(w.createElement("p")),g._4e_appendBogus(a),w.body.appendChild(g[0]));b.setStartAt(g,m.RANGE.POSITION_AFTER_START);b.select()}w.execCommand("inserthtml",d,c)},50)}setTimeout(function(){s.getSelection().scrollIntoView()},50);G.call(s)}}});m._initIFrame=function(a){var s=q.getInstance(a),g=s.get("document")[0],a=g.getElementById("ke_active_script");t.remove(a);p(s);var w=g.body;l?(w.hideFocus=b,w.disabled=b,w.contentEditable=b,w.removeAttribute("disabled")):setTimeout(function(){c.gecko||
c.opera?w.contentEditable=b:c.webkit?w.parentNode.contentEditable=b:g.designMode="on"},0);if(c.gecko||c.opera){var z=g.documentElement;A.on(z,"mousedown",function(a){if(a.target==z){c.gecko&&x(g,d);s.activateGecko()}})}setTimeout(function(){l&&setTimeout(function(){if(g){w.runtimeStyle.marginBottom="0px";w.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){s.__docReady=1;s.fire("docReady");var a=s.get("disableObjectResizing"),c=s.get("disableInlineTableEditing");if(a||c)try{g.execCommand("enableObjectResizing",
d,!a);g.execCommand("enableInlineTableEditing",d,!c)}catch(b){A.on(w,l?"resizestart":"resize",function(d){var b=new D(d.target);(a||b.nodeName()==="table"&&c)&&d.preventDefault()})}},10)};var G=e.buffer(function(){this.execCommand("save")},50);return m},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
KISSY.add("editor/core/elementPath",function(e){function m(e){for(var o=i,m=i,p=[];e;){if(e[0].nodeType==q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=e);var y=e.nodeName();if(!m&&(!o&&f[y]&&(o=e),k[y])){var v;if(v=!o)if(v="div"==y){a:{v=e[0].childNodes;for(var j=0,b=v.length;j<b;j++){var a=v[j];if(a.nodeType==q.NodeType.ELEMENT_NODE&&r.$block[a.nodeName.toLowerCase()]){v=!0;break a}}v=!1}v=!v}v?o=e:m=e}p.push(e);if("body"==y)break}e=e.parent()}this.block=o;this.blockLimit=m;this.elements=
p}var u=e.Editor,q=e.DOM,r=u.XHTML_DTD,i=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},k={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};m.prototype={compare:function(f){var e=this.elements,f=f&&f.elements;if(!f||e.length!=f.length)return!1;for(var i=0;i<e.length;i++)if(!q.equals(e[i],f[i]))return!1;return!0},contains:function(f){for(var e=this.elements,k=0;k<e.length;k++)if(e[k].nodeName()in f)return e[k];return i},toString:function(){var f=
this.elements,e,i=[];for(e=0;e<f.length;e++)i.push(f[e].nodeName());return i.toString()}};return u.ElementPath=m},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(e,m,u,q){function r(i){var m;m=i.getSelection().getRanges();for(var r=m.length-1;0<r;r--)m[r].deleteContents();m=m[0];r=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var j=(new q(m.startContainer)).block;if(j&&("li"==j.nodeName()||"li"==j.parent().nodeName()))return i.hasCommand("outdent")?(i.execCommand("save"),i.execCommand("outdent"),i.execCommand("save"),!0):!1}var b=m.splitBlock("p");if(!b)return!0;var i=b.previousBlock,j=b.nextBlock,a=b.wasStartOfBlock,
h=b.wasEndOfBlock,d;if(j)d=j.parent(),"li"==d.nodeName()&&(j._4e_breakParent(d),j._4e_move(j.next(),!0));else if(i&&(d=i.parent())&&"li"==d.nodeName())i._4e_breakParent(d),m.moveToElementEditablePosition(i.next()),i._4e_move(i.prev());if(!a&&!h){if("li"==j.nodeName()&&(d=j.first(u.invisible(!0)))&&e.inArray(d.nodeName(),["ul","ol"]))(f.ie?new o(r.createTextNode("\u00a0")):new o(r.createElement("br"))).insertBefore(d);j&&m.moveToElementEditablePosition(j)}else{var g;if(i){if("li"==i.nodeName()||!k.test(i.nodeName()))g=
i.clone()}else j&&(g=j.clone());g||(g=new o("<p>",null,r));if(d=b.elementPath)for(var b=0,c=d.elements.length;b<c;b++){var l=d.elements[b];if(l.equals(d.block)||l.equals(d.blockLimit))break;n.$removeEmpty[l.nodeName()]&&(l=l.clone(),g._4e_moveChildren(l),g.append(l))}f.ie||g._4e_appendBogus();m.insertNode(g);if(f.ie&&a&&(!h||!i[0].childNodes.length))m.moveToElementEditablePosition(h?i:g),m.select();m.moveToElementEditablePosition(a&&!h?j:g)}f.ie||(j?(g=new o(r.createElement("span")),g.html("&nbsp;"),
m.insertNode(g),g.scrollIntoView(void 0,!1),m.deleteContents()):g.scrollIntoView(void 0,!1));m.select();return!0}function i(f){var e=f.get("document")[0];x.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){f.execCommand("save");var i=f.execCommand("enterBlock");f.execCommand("save");!1!==i&&e.preventDefault()}})}var f=e.UA,k=/^h[1-6]$/,n=m.XHTML_DTD,o=e.Node,x=e.Event;return{init:function(f){f.addCommand("enterBlock",{exec:r});f.docReady(function(){i(f)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(e){function m(){var e=this;e.__iframeFocus=n;k=e;f&&clearTimeout(f);f=setTimeout(function(){e.fire("focus")},100)}function u(){var e=this;e.__iframeFocus=o;k=x;f&&clearTimeout(f);f=setTimeout(function(){e.fire("blur")},100)}var q=e.Editor,r=e.Event,i={},f,k,e={refreshAll:function(){for(var f in i)if(i.hasOwnProperty(f)){var e=i[f].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return k},getInstance:function(f){return i[f]},
add:function(f){var e=f.get("window")[0];r.on(e,"focus",m,f);r.on(e,"blur",u,f)},register:function(f){i[f._UUID]=f},remove:function(f){delete i[f._UUID];var e=f.get("window")[0];r.remove(e,"focus",m,f);r.remove(e,"blur",u,f)}},n=!0,o=!1,x=null;e.refreshAll=e.refreshAll;q.focusManager=e;q.getInstances=function(){return i};return e},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(e,m){return{init:function(u){function q(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function r(a){return a.replace(y,function(a,c,d){return"<"+c+d.replace(v,function(a,c){return-1==d.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function i(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function f(c){return c.replace(a,function(a,c){return decodeURIComponent(c)})}var k=e.Node,n=e.UA,o=e.require("htmlparser"),x=new o.Filter,p=new o.Filter;(function(){function a(c){c=o.serialize(c);return new o.Comment(j+encodeURIComponent(c).replace(/--/g,"%2D%2D"))}var d={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:a,noscript:a,span:q}},b={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=
["name","href","src"],d,b=0;b<c.length;b++)d="_ke_saved_"+c[b],a.getAttribute(d)&&a.removeAttribute(c[b]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var d=c.getAttribute("width"),c=c.getAttribute("height");d&&a.setAttribute("width",d);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:q},attributes:{style:function(a){if(!e.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(a){if(a.substr(0,j.length)==j)return a=e.trim(decodeURIComponent(a.substr(j.length))),o.parse(a).childNodes[0]}};n.ie&&(b.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(b);p.addRules(d)})();(function(){function a(c){for(var c=c.childNodes,d=c.length,b=c[d-1];b&&3==b.nodeType&&!e.trim(b.nodeValue);)b=c[--d];return b}function d(b,s){var g=a(b);g&&((s||!n.ie)&&1==g.nodeType&&"br"==g.nodeName?b.removeChild(g):
3==g.nodeType&&h.test(g.nodeValue)&&b.removeChild(g))}function b(d){var s=a(d);return!s||1==s.nodeType&&"br"==s.nodeName||"form"==d.nodeName&&"input"==s.nodeName}function g(a){d(a,!0);b(a)&&(n.ie?a.appendChild(new o.Text("\u00a0")):(a.appendChild(new o.Text("&nbsp;")),a.appendChild(new o.Tag("br"))))}function f(a){d(a,!1);b(a)&&a.appendChild(new o.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,i=m.XHTML_DTD,s=e.merge(i.$block,i.$listItem,i.$tableContent),z;for(z in s)s.hasOwnProperty(z)&&("br"in i[z]||
delete s[z]);delete s.td;delete s.pre;var i={tags:{}},w={tags:{}};for(z in s)s.hasOwnProperty(z)&&(i.tags[z]=g,w.tags[z]=f);p.addRules(i);x.addRules(w)})();x.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var y=/<(a|area|img|input)\b([^>]*)>/gi,v=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",b=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,a=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,h=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
d=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,g=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;u.htmlDataProcessor={dataFilter:p,htmlFilter:x,toHtml:function(a){var d=new o.BeautifyWriter;(new o.Parser(a)).parse().writeHtml(d,x);return a=d.getHtml()},toDataFormat:function(a,b){var b=b||p,a=r(a),a=i(a),a=a.replace(h,"$1ke:$2"),a=a.replace(g,"<ke:$1$2></ke:$1>"),e=new k("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(d,"$1$2");a=f(a);e=new o.BasicWriter;
(new o.Parser(a)).parse().writeHtml(e,b);return a=e.getHtml()},toServer:function(a){var d=new o.MinifyWriter;(new o.Parser(a)).parse().writeHtml(d,x);return d.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/range",function(e,m,u,q,r){function i(c){var b=c.nodeType!=a.NodeType.TEXT_NODE&&a.nodeName(c)in d.$removeEmpty,g=c.nodeType==a.NodeType.TEXT_NODE&&!e.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return b||g||c}function f(a){return!t(a)&&!C(a)}function k(c){var d=y;return function(b){if(C(b))return p;if(b.nodeType==a.NodeType.TEXT_NODE){if(e.trim(b.nodeValue).length)return y}else if(b.nodeType==a.NodeType.ELEMENT_NODE&&(b=a.nodeName(b),!E[b]))if(!c&&!h.ie&&
"br"==b&&!d)d=p;else return y;return p}}function n(c,d){var b=c.startContainer,f=c.endContainer,e=c.startOffset,l=c.endOffset,h,i=y,t=y,j=void 0,k=c.document,m;0<d&&(j=k.createDocumentFragment());if(c.collapsed)return j;c.optimizeBookmark();f[0].nodeType==a.NodeType.TEXT_NODE?(t=p,f=f._4e_splitText(l)):0<f[0].childNodes.length&&(l>=f[0].childNodes.length?(f=new g(f[0].appendChild(k.createTextNode(""))),m=p):f=new g(f[0].childNodes[l]));b[0].nodeType==a.NodeType.TEXT_NODE?(i=p,b._4e_splitText(e)):
e?e>=b[0].childNodes.length?(b=new g(b[0].appendChild(k.createTextNode(""))),h=p):b=new g(b[0].childNodes[e].previousSibling):(h=new g(k.createTextNode("")),b.prepend(h),b=h,h=p);var H=b._4e_parents(),K=f._4e_parents();H.each(function(a,c){H[c]=a});K.each(function(a,c){K[c]=a});for(var F,N,k=0;k<H.length&&!(F=H[k],N=K[k],!F.equals(N));k++);for(var e=j,B,J,O=k;O<H.length;O++){B=H[O];l=0<d&&!B.equals(b)?e.appendChild(B.clone()[0]):null;B=B[0].nextSibling;J=K[O];for(var o=f[0],C=J&&J[0];B&&!(C==B||o==
B);)J=B.nextSibling,2==d?e.appendChild(B.cloneNode(p)):(a._4e_remove(B),1==d&&e.appendChild(B)),B=J;l&&(e=l)}for(e=j;k<K.length;k++){B=K[k];l=0<d&&!B.equals(f)?e.appendChild(B.clone()[0]):null;if(!H[k]||!B._4e_sameLevel(H[k]))for(B=B[0].previousSibling;B;)J=B.previousSibling,2==d?e.insertBefore(B.cloneNode(p),e.firstChild):(a._4e_remove(B),1==d&&e.insertBefore(B,e.firstChild)),B=J;l&&(e=l)}if(2==d){if(i&&(F=b[0],F.nodeType==a.NodeType.TEXT_NODE&&F.nextSibling&&F.nextSibling.nodeType==a.NodeType.TEXT_NODE&&
(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),t)t=f[0],t.nodeType==a.NodeType.TEXT_NODE&&t.previousSibling&&t.previousSibling.nodeType==a.NodeType.TEXT_NODE&&(t.previousSibling.data+=t.data,t.parentNode.removeChild(t))}else{if(F&&N&&(!b._4e_sameLevel(F)||!f._4e_sameLevel(N)))t=F._4e_index(),h&&F._4e_sameLevel(b)&&t--,c.setStart(F.parent(),t+1);c.collapse(p)}h&&b.remove();m&&f.remove();return j}function o(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=v;this.collapsed=p;this.document=a}m.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var p=!0,y=!1,v=null,j=m.RANGE,b=m.POSITION,a=e.DOM,h=e.UA,d=m.XHTML_DTD,g=e.Node,c=g.all,l={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},t=new q.whitespaces,C=new q.bookmark,D=q.whitespaces(p),A=q.bookmark(!1,!0),E={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};e.augment(x,{toString:function(){var a=[],c=this.startContainer[0],d=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((d.id||d.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var c=
this.startContainer,d=this.startOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(d?d>=c[0].nodeValue.length&&this.setStartAfter(c):this.setStartBefore(c));c=this.endContainer;d=this.endOffset;c[0].nodeType!=a.NodeType.ELEMENT_NODE&&(d?d>=c[0].nodeValue.length&&this.setEndAfter(c):this.setEndBefore(c))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(c,d){c[0].nodeType==a.NodeType.ELEMENT_NODE&&l[c.nodeName()]&&(c=c.parent(),d=c._4e_index());this.startContainer=c;this.startOffset=d;this.endContainer||(this.endContainer=c,this.endOffset=d);o(this)},
setEnd:function(c,d){c[0].nodeType==a.NodeType.ELEMENT_NODE&&l[c.nodeName()]&&(c=c.parent(),d=c._4e_index()+1);this.endContainer=c;this.endOffset=d;this.startContainer||(this.startContainer=c,this.startOffset=d);o(this)},setStartAt:function(c,d){switch(d){case j.POSITION_AFTER_START:this.setStart(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setStart(c,c[0].nodeValue.length):this.setStart(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(c);
break;case j.POSITION_AFTER_END:this.setStartAfter(c)}o(this)},setEndAt:function(c,d){switch(d){case j.POSITION_AFTER_START:this.setEnd(c,0);break;case j.POSITION_BEFORE_END:c[0].nodeType==a.NodeType.TEXT_NODE?this.setEnd(c,c[0].nodeValue.length):this.setEnd(c,c[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(c);break;case j.POSITION_AFTER_END:this.setEndAfter(c)}o(this)},cloneContents:function(){return n(this,2)},deleteContents:function(){return n(this,0)},extractContents:function(){return n(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=p},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var c=this.clone();c.optimize();if(c.startContainer[0].nodeType!=a.NodeType.ELEMENT_NODE||
c.endContainer[0].nodeType!=a.NodeType.ELEMENT_NODE)return v;var d=new q(c);d.evaluator=function(a){return D(a)&&A(a)};c=d.next();d.reset();d=d.previous();return c&&c.equals(d)?c:v},shrink:function(c,d){if(!this.collapsed){var c=c||j.SHRINK_TEXT,b=this.clone(),g=this.startContainer,f=this.endContainer,e=this.startOffset,l=this.endOffset,h=p,i,t,k=p;g&&g[0].nodeType==a.NodeType.TEXT_NODE&&(e?e>=g[0].nodeValue.length?b.setStartAfter(g):(b.setStartBefore(g),h=y):b.setStartBefore(g));f&&f[0].nodeType==
a.NodeType.TEXT_NODE&&(l?l>=f[0].nodeValue.length?b.setEndAfter(f):(b.setEndAfter(f),k=y):b.setEndBefore(f));if(h||k)t=new q(b),t.evaluator=function(d){return d.nodeType==(c==j.SHRINK_ELEMENT?a.NodeType.ELEMENT_NODE:a.NodeType.TEXT_NODE)},t.guard=function(d,b){if(c==j.SHRINK_ELEMENT&&d.nodeType==a.NodeType.TEXT_NODE||b&&d==i)return y;!b&&d.nodeType==a.NodeType.ELEMENT_NODE&&(i=d);return p};h&&(b=t[c==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(b,d?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);
k&&(t.reset(),(t=t[c==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(t,d?j.POSITION_BEFORE_END:j.POSITION_AFTER_END));return h||k}},createBookmark2:function(c){var d=this.startContainer,b=this.endContainer,f=this.startOffset,e=this.endOffset,l,h;if(!d||!b)return{start:0,end:0};if(c){if(d[0].nodeType==a.NodeType.ELEMENT_NODE&&(l=new g(d[0].childNodes[f]))&&l[0]&&l[0].nodeType==a.NodeType.TEXT_NODE&&0<f&&l[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)d=l,f=0;for(;d[0].nodeType==
a.NodeType.TEXT_NODE&&(h=d.prev(void 0,1))&&h[0].nodeType==a.NodeType.TEXT_NODE;)d=h,f+=h[0].nodeValue.length;if(!this.collapsed){if(b[0].nodeType==a.NodeType.ELEMENT_NODE&&(l=new g(b[0].childNodes[e]))&&l[0]&&l[0].nodeType==a.NodeType.TEXT_NODE&&0<e&&l[0].previousSibling.nodeType==a.NodeType.TEXT_NODE)b=l,e=0;for(;b[0].nodeType==a.NodeType.TEXT_NODE&&(h=b.prev(void 0,1))&&h[0].nodeType==a.NodeType.TEXT_NODE;)b=h,e+=h[0].nodeValue.length}}return{start:d._4e_address(c),end:this.collapsed?v:b._4e_address(c),
startOffset:f,endOffset:e,normalized:c,is2:p}},createBookmark:function(a){var c,d,b,f,l=this.collapsed;c=new g("<span>",v,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");a&&(b=e.guid("ke_bm_"),c.attr("id",b+"S"));l||(d=c.clone(),d.html("&nbsp;"),a&&d.attr("id",b+"E"),f=this.clone(),f.collapse(),f.insertNode(d));f=this.clone();f.collapse(p);f.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,j.POSITION_AFTER_END);return{startNode:a?
b+"S":c,endNode:a?b+"E":d,serializable:a,collapsed:l}},moveToPosition:function(a,c){this.setStartAt(a,c);this.collapse(p)},trim:function(c,d){var b=this.startContainer,g=this.startOffset,f=this.collapsed;if((!c||f)&&b[0]&&b[0].nodeType==a.NodeType.TEXT_NODE){if(g)if(g>=b[0].nodeValue.length)g=b._4e_index()+1,b=b.parent();else{var e=b._4e_splitText(g),g=b._4e_index()+1,b=b.parent();a.equals(this.startContainer,this.endContainer)?this.setEnd(e,this.endOffset-this.startOffset):a.equals(b,this.endContainer)&&
(this.endOffset+=1)}else g=b._4e_index(),b=b.parent();this.setStart(b,g);if(f){this.collapse(p);return}}b=this.endContainer;g=this.endOffset;!d&&!f&&b[0]&&b[0].nodeType==a.NodeType.TEXT_NODE&&(g?(g>=b[0].nodeValue.length||b._4e_splitText(g),g=b._4e_index()+1):g=b._4e_index(),b=b.parent(),this.setEnd(b,g))},insertNode:function(a){this.optimizeBookmark();this.trim(y,p);var c=this.startContainer;c[0].insertBefore(a[0],c[0].childNodes[this.startOffset]||null);c[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(a){var d=c(this.document);if(a.is2){var b=d._4e_getByAddress(a.start,a.normalized),g=a.startOffset,d=a.end&&d._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(b,g);d?this.setEnd(d,a):this.collapse(p)}else b=(g=a.serializable)?e.one("#"+a.startNode,d):a.startNode,a=g?e.one("#"+a.endNode,d):a.endNode,this.setStartBefore(b),b._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(p)},getCommonAncestor:function(c,d){var b=
this.startContainer,f=this.endContainer,b=b[0]==f[0]?c&&b[0].nodeType==a.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new g(b[0].childNodes[this.startOffset]):b:b._4e_commonAncestor(f);return d&&b[0].nodeType==a.NodeType.TEXT_NODE?b.parent():b},enlarge:function(){function d(b,g,f,e){var l=b[g?"startContainer":"endContainer"],h,i=g?0:1,s=0,j=g?"previousSibling":"nextSibling";h=b[g?"startOffset":"endOffset"];if(l[0].nodeType==a.NodeType.TEXT_NODE){if(g){if(h)return}else if(h<l[0].nodeValue.length)return;
h=l[0][j];l=l[0].parentNode}else h=l[0].childNodes[h+(g?-1:1)]||null,l=l[0];for(;l;){for(;h;)if(t(h)||C(h))h=h[j];else break;if(h){if(!s)b[g?"setStartAfter":"setEndBefore"](c(h));break}l=c(l);if("body"==l.nodeName())break;if(s||l.equals(e))f[i]=l,s=1;else b[g?"setStartBefore":"setEndAfter"](l);h=l[0][j];l=l[0].parentNode}}return function(b){switch(b){case j.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),f=[];d(this,1,f,b);d(this,0,f,b);f[0]&&f[1]&&(b=f[0].contains(f[1])?f[1]:
f[0],this.setStartBefore(b),this.setEndAfter(b));break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:var l=new x(this.document),f=new g(this.document.body);l.setStartAt(f,j.POSITION_AFTER_START);l.setEnd(this.startContainer,this.startOffset);var l=new q(l),e,h,t=q.blockBoundary(b==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:v),i=function(a){var d=t(a);d||(e=c(a));return d},k=function(d){var b=i(d);!b&&"br"==a.nodeName(d)&&(h=c(d));return b};l.guard=i;l=l.lastBackward();e=e||f;this.setStartAt(e,
"br"!=e.nodeName()&&(!l&&this.checkStartOfBlock()||l&&e.contains(l))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);l=this.clone();l.collapse();l.setEndAt(f,j.POSITION_BEFORE_END);l=new q(l);l.guard=b==j.ENLARGE_LIST_ITEM_CONTENTS?k:i;e=v;l=l.lastForward();e=e||f;this.setEndAt(e,!l&&this.checkEndOfBlock()||l&&e.contains(l)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),checkStartOfBlock:function(){var c=this.startContainer,d=this.startOffset;if(d&&c[0].nodeType==a.NodeType.TEXT_NODE&&
e.trim(c[0].nodeValue.substring(0,d)).length)return y;this.trim();c=new r(this.startContainer);d=this.clone();d.collapse(p);d.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new q(d);c.evaluator=k(p);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,d=this.endOffset;if(c[0].nodeType==a.NodeType.TEXT_NODE&&e.trim(c[0].nodeValue.substring(d)).length)return y;this.trim();c=new r(this.endContainer);d=this.clone();d.collapse(y);d.setEndAt(c.block||c.blockLimit,j.POSITION_BEFORE_END);
c=new q(d);c.evaluator=k(y);return c.checkForward()},checkBoundaryOfElement:function(a,c){var d=this.clone();d[c==j.START?"setStartAt":"setEndAt"](a,c==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);d=new q(d);d.evaluator=i;return d[c==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var d=this.startContainer,g=this.endContainer,f=this.startOffset,l=this.endOffset,e;if(d[0].nodeType==a.NodeType.ELEMENT_NODE)if(e=d[0].childNodes.length,e>f)d=c(d[0].childNodes[f]);else if(0==
e)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=c(d);d=d._4e_nextSourceNode()||d}if(g[0].nodeType==a.NodeType.ELEMENT_NODE)if(e=g[0].childNodes.length,e>l)g=c(g[0].childNodes[l])._4e_previousSourceNode(p);else if(0==e)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=c(g)}d._4e_position(g)&b.POSITION_FOLLOWING&&(d=g);return{startNode:d,endNode:g}},fixBlock:function(a,d){var b=this.createBookmark(),g=c(this.document.createElement(d));this.collapse(a);
this.enlarge(j.ENLARGE_BLOCK_CONTENTS);g[0].appendChild(this.extractContents());g._4e_trim();h.ie||g._4e_appendBogus();this.insertNode(g);this.moveToBookmark(b);return g},splitBlock:function(a){var c=new r(this.startContainer),d=new r(this.endContainer),b=c.block,g=d.block,f=v;if(!c.blockLimit.equals(d.blockLimit))return v;"br"!=a&&(b||(b=this.fixBlock(p,a),g=(new r(this.endContainer)).block),g||(g=this.fixBlock(y,a)));a=b&&this.checkStartOfBlock();c=g&&this.checkEndOfBlock();this.deleteContents();
b&&b[0]==g[0]&&(c?(f=new r(this.startContainer),this.moveToPosition(g,j.POSITION_AFTER_END),g=v):a?(f=new r(this.startContainer),this.moveToPosition(b,j.POSITION_BEFORE_START),b=v):(g=this.splitElement(b),!h.ie&&!e.inArray(b.nodeName(),["ul","ol"])&&b._4e_appendBogus()));return{previousBlock:b,nextBlock:g,wasStartOfBlock:a,wasEndOfBlock:c,elementPath:f}},splitElement:function(a){if(!this.collapsed)return v;this.setEndAt(a,j.POSITION_BEFORE_END);var c=this.extractContents(),d=a.clone(y);d[0].appendChild(c);
d.insertAfter(a);this.moveToPosition(a,j.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(c,d){for(var b=0;c;){if(c[0].nodeType==a.NodeType.TEXT_NODE){this.moveToPosition(c,d?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);b=1;break}c[0].nodeType==a.NodeType.ELEMENT_NODE&&c._4e_isEditable()&&(this.moveToPosition(c,d?j.POSITION_BEFORE_END:j.POSITION_AFTER_START),b=1);var g=c,l=b,e=void 0;g[0].nodeType==a.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(e=g[d?"last":"first"](f,1));!l&&
!e&&(e=g[d?"prev":"next"](f,1));c=e}return!!b},selectNodeContents:function(c){var d=c[0];this.setStart(c,0);this.setEnd(c,d.nodeType==a.NodeType.TEXT_NODE?d.nodeValue.length:d.childNodes.length)},insertNodeByDtd:function(a){var c,b,g,f=a.nodeName();c=d.$block[f];this.deleteContents();if(c){for(c=this.getCommonAncestor(y,p);(b=d[c.nodeName()])&&(!b||!b[f]);){var l=c.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(c),this.collapse(p),c.remove()):g=c;c=l}g&&this.splitElement(g)}this.insertNode(a)}});
u.injectDom({_4e_breakParent:function(a,d){var d=c(d),a=c(a),b,g=new m.Range(a[0].ownerDocument);g.setStartAfter(a);g.setEndAfter(d);b=g.extractContents();g.insertNode(a.remove());a.after(b)}});return m.Range=x},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(e){function m(a){this.document=a;this._={cache:{}};if(p)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=r}catch(c){this.isInvalid=r}}function u(a){a=new m(a);return!a||a.isInvalid?i:a}var q=e.Editor;q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=!0,i=null,f=e.UA,k=e.DOM,n=e.Node,o=q.SELECTION,x=q.RANGE,p=f.ie,y=q.Walker,v=q.Range,
j={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};e.augment(m,{getNative:!p?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=k._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!p?function(){var a=this._.cache;if(a.type)return a.type;var b=o.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=
c.getRangeAt(0),f=c.startContainer;f==c.endContainer&&f.nodeType==k.NodeType.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&j[f.childNodes[c.startOffset].nodeName.toLowerCase()]&&(b=o.SELECTION_ELEMENT)}}else b=o.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=o.SELECTION_NONE;try{var c=this.getNative(),f=c.type;"Text"==f&&(b=o.SELECTION_TEXT);"Control"==f&&(b=o.SELECTION_ELEMENT);c.createRange().parentElement&&(b=o.SELECTION_TEXT)}catch(e){}return a.type=
b},getRanges:p?function(){var a=function(a,c){a=a.duplicate();a.collapse(c);for(var d=a.parentElement(),b=d.childNodes,f,e=0;e<b.length;e++){var h=b[e];if(h.nodeType==k.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(h);var h=f.compareEndPoints("StartToStart",a),j=f.compareEndPoints("EndToStart",a);f.collapse();if(0<h)break;else{if(!h||1==j&&-1==h)return{container:d,offset:e};if(!j)return{container:d,offset:e+1}}f=i}}f||(f=a.duplicate(),f.moveToElementText(d),f.collapse(!1));f.setEndPoint("StartToStart",
a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=b[--e].nodeValue.length}catch(m){f=0}return 0===f?{container:d,offset:e}:{container:b[e],offset:-f}};return function(b){var c=this._.cache;if(c.ranges&&!b)return c.ranges;var f=this.getNative(),b=f&&f.createRange(),e=this.getType();if(!f)return[];if(e==o.SELECTION_TEXT)return f=new v(this.document),e=a(b,r),f.setStart(new n(e.container),e.offset),e=a(b),f.setEnd(new n(e.container),e.offset),c.ranges=[f];if(e==o.SELECTION_ELEMENT){c=
c.ranges=[];for(e=0;e<b.length;e++){for(var h=b.item(e),i=h.parentNode,j=0,f=new v(this.document);j<i.childNodes.length&&i.childNodes[j]!=h;j++);f.setStart(new n(i),j);f.setEnd(new n(i),j+1);c.push(f)}return c}return c.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],c=this.getNative();if(!c)return[];for(var f=0;f<c.rangeCount;f++){var e=c.getRangeAt(f),h=new v(this.document);h.setStart(new n(e.startContainer),e.startOffset);h.setEnd(new n(e.endContainer),e.endOffset);
a.push(h)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,c=this.getNative();switch(this.getType()){case o.SELECTION_ELEMENT:return this.getSelectedElement();case o.SELECTION_TEXT:var f=this.getRanges()[0];if(f&&!f.collapsed){for(f.optimize();r;)if(b=f.startContainer,f.startOffset==(b[0].nodeType===k.NodeType.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())f.setStartAfter(b);else break;b=f.startContainer;
if(b[0].nodeType!=k.NodeType.ELEMENT_NODE)return b.parent();b=new n(b[0].childNodes[f.startOffset]);if(!b[0]||b[0].nodeType!=k.NodeType.ELEMENT_NODE)return f.startContainer;for(f=b[0].firstChild;f&&f.nodeType==k.NodeType.ELEMENT_NODE;)b=new n(f),f=f.firstChild;return b}if(p)f=c.createRange(),f.collapse(r),b=new n(f.parentElement());else{if((b=c.anchorNode)&&b.nodeType!=k.NodeType.ELEMENT_NODE)b=b.parentNode;b&&(b=new n(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;
if(void 0!==b.selectedElement)return b.selectedElement;p&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var c;if(a)c=new n(a);else{a=this.getRanges()[0];for(var f,e=2;e&&(!(c=a.getEnclosedNode())||!(c[0].nodeType==k.NodeType.ELEMENT_NODE&&j[c.nodeName()]&&(f=c)));e--)a.shrink(x.SHRINK_ELEMENT);c=f}return b.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(p)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(f){b=c.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(p){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var c=0;c<a.length;c++){var e=a[c],h=this.document.createRange(),i=e.startContainer;if(e.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&i[0].nodeType==
k.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;h.setStart(i[0],e.startOffset);h.setEnd(e.endContainer[0],e.endOffset);b.addRange(h)}}this.reset()},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),f=0;f<c.length;f++)b.push(c[f].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],f=this.document,h,b=b||this.getRanges(),i=b.length,j=0;j<i;j++){c.push(h=b[j].createBookmark(a,
r));var m=(a=h.serializable)?e.one("#"+h.startNode,f):h.startNode;h=a?e.one("#"+h.endNode,f):h.endNode;for(var o=j+1;o<i;o++){var s=b[o],p=s.startContainer,n=s.endContainer;k.equals(p,m.parent())&&s.startOffset++;k.equals(p,h.parent())&&s.startOffset++;k.equals(n,m.parent())&&s.endOffset++;k.equals(n,h.parent())&&s.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var f=new v(this.document);f.moveToBookmark(a[c]);b.push(f)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();p?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},a=y.whitespaces(r),h=/\ufeff|\u00a0/;v.prototype.select=v.prototype.select=!p?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==k.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));
var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(r),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=u(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(d){var f=this.collapsed,c,e;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];
if(i.nodeType==k.NodeType.ELEMENT_NODE){(new m(this.document)).selectElement(new n(i));return}}(this.startContainer[0].nodeType==k.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==k.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(x.SHRINK_ELEMENT,r);var j=this.createBookmark(),i=j.startNode,o;f||(o=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(i[0]);j.moveStart("character",1);if(o)d=this.document.body.createTextRange(),
d.moveToElementText(o[0]),j.setEndPoint("EndToEnd",d),j.moveEnd("character",-1);else{for(c=i[0].nextSibling;c&&!a(c);)c=c.nextSibling;c=!(c&&c.nodeValue&&c.nodeValue.match(h))&&(d||!i[0].previousSibling||i[0].previousSibling&&"br"==k.nodeName(i[0].previousSibling));e=new n(this.document.createElement("span"));e.html("&#65279;");e.insertBefore(i);c&&k.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(f){if(c?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):
j.select(),e)this.moveToPosition(e,x.POSITION_BEFORE_START),e._4e_remove()}else this.setEndBefore(o),o._4e_remove(),j.select()};m.getSelection=u;return q.Selection=m},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(e,m){function u(f){function b(a,b){var d=c.body.createTextRange();try{d.moveToPoint(a,b)}catch(f){d=n}return d}function a(){var b=c.selection.createRange();i&&!b.item&&0===b.compareEndPoints("StartToEnd",b)&&i.select();x.remove(c,"mouseup",a);x.remove(c,"mousemove",e);i=d=0}function e(c){if(c.button){if(c=b(c.pageX,c.pageY))0<c.compareEndPoints("StartToStart",i)?c.setEndPoint("StartToStart",i):c.setEndPoint("EndToEnd",i),c.select()}else a()}var d,g=f.get("window")[0],
c=f.get("document")[0],i;x.on(c,"mousedown contextmenu",function(f){var j=c.documentElement;if(f.target===j&&(d&&a(),!(j.scrollHeight>j.clientHeight)&&(d=1,i=b(f.pageX,f.pageY))))x.on(c,"mouseup",a),x.on(c,"mousemove",e),g.focus(),i.select()})}function q(e){function b(d){if(c){var h=e.getSelection(),i=h&&h.getType(),l=h&&a.selection;if(d&&l&&i==v.SELECTION_NONE&&!a.queryCommandEnabled("InsertImage"))setTimeout(function(){b(f)},50);else{var k;if(!l||!l.type||!("Control"!=l.type&&(k=l.createRange())&&
(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))g=l&&h.getRanges()[0],e.checkSelectionChange()}}}var a=e.get("document")[0],h=new y(a.body),d=new y(a.documentElement);if(8>m.Utils.ieEngine)d.on("click",function(a){"html"===(new y(a.target)).nodeName()&&e.getSelection().getNative().createRange().select()});var g,c,i=f;d.on("mousedown",function(){i=k});d.on("mouseup",function(){i=f});h.on("focusin",function(a){if("body"==(new y(a.target)).nodeName()&&g){try{i&&g.select()}catch(b){}g=
n}});h.on("focus",function(){c=f;b()});h.on("beforedeactivate",function(a){a.relatedTarget||(c=k,i=f)});h.on("mousedown",function(){c=k});h.on("mouseup",function(){c=f;setTimeout(function(){b(f)},0)});h.on("keydown",function(){c=k});h.on("keyup",function(){c=f;setTimeout(function(){b()},0)})}function r(f){var b=f.get("document")[0];x.on(b,"mouseup keyup selectionchange",function(){f.checkSelectionChange()})}function i(e){function b(a){var b=m.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function a(a){return d(a)&&g(a)}var h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,d=m.Walker.whitespaces(f),g=m.Walker.bookmark(k,f),c=function(a){return d(a)&&8!=a.nodeType};e.on("selectionChange",function(d){var g=d.path,i=new y(e.get("document")[0].body),d=(d=d.selection)&&d.getRanges()[0],n=g.blockLimit;if(o.gecko){var r=g.block||g.blockLimit,q=r&&r.last(a);r&&r._4e_isBlockBoundary()&&(!q||!(1==q[0].nodeType&&
q._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(d&&d.collapsed&&!g.block){if("body"==n.nodeName()){if((g=d.fixBlock(f,"p"))&&g[0]!=i[0].lastChild&&g._4e_outerHtml().match(h))if((n=g.next(c,1))&&n[0].nodeType==p.NodeType.ELEMENT_NODE&&!b[n])d.moveToElementEditablePosition(n),g._4e_remove();else if((n=g.prev(c,1))&&n[0].nodeType==p.NodeType.ELEMENT_NODE&&!b[n])d.moveToElementEditablePosition(n,n._4e_outerHtml().match(h)?k:f),g._4e_remove();d.select();e.notifySelectionChange()}g=
e.get("document")[0];d=new m.Range(g);d.moveToElementEditablePosition(i,f);"body"!==(new m.ElementPath(d.startContainer)).blockLimit.nodeName()&&(i=(new y(g.createElement("p"))).appendTo(i),o.ie||i._4e_appendBogus())}})}var f=!0,k=!1,n=null,o=e.UA,x=e.Event,p=e.DOM,y=e.Node,v=m.SELECTION;return{init:function(f){f.docReady(function(){o.ie?(u(f),q(f)):r(f)});i(f)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(e,m){function u(a){return!A.attr(a,"_ke_bookmark")}function q(a,b){for(var c in a)a.hasOwnProperty(c)&&(e.isString(a[c])?a[c]=a[c].replace(T,function(a,c){return b[c]}):q(a[c],b))}function r(a,b){b&&(a=e.clone(a),q(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==c||S[c]?E.STYLE_BLOCK:Q[c]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:a}}function i(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new z(a),f=d.getRanges(),e=0;e<f.length;e++)c.call(this,f[e]);d.selectRanges(f)}function f(a,b,c){var d=a.element;"*"==d&&(d="span");b=new G(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=r.getStyleText(c);if(a)for(var f in a)a.hasOwnProperty(f)&&b.attr(f,a[f]);c&&(b[0].style.cssText=c);return b}function k(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var d,e=a.document;d=c.getNextParagraph();){var g=f(this,e,
d),h=g,g="pre"==h.nodeName,i="pre"==d.nodeName,j=!g&&i;g&&!i?(i=d,j=i.html(),j=n(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),M.ie?(i=i[0].ownerDocument.createElement("div"),i.appendChild(h[0]),h[0].outerHTML="<pre>"+j+"</pre>",h=new G(i.firstChild),h._4e_remove()):h.html(j)):j?h=x(o(d),h):d._4e_moveChildren(h);d[0].parentNode.replaceChild(h[0],d[0]);if(g&&(d=h,g=void 0,(g=d._4e_previousSourceNode(l,
A.NodeType.ELEMENT_NODE))&&"pre"==g.nodeName()))h=n(g.html(),/\n$/,"")+"\n\n"+n(d.html(),/^\n/,""),M.ie?d[0].outerHTML="<pre>"+h+"</pre>":d.html(h),g._4e_remove()}a.moveToBookmark(b)}function n(a,b,c){var d="",f="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(d=b);c&&(f=c);return""});return d+a.replace(b,c)+f}function o(a){var b=[];n(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+
"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function x(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),d=0;d<a.length;d++){var f=a[d],f=f.replace(/(\r\n|\r)/g,"\n"),f=n(f,/^[ \t]*\n/,""),f=n(f,/\n$/,""),f=n(f,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),f=f.replace(/\n/g,"<br>"),f=f.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+
" "}),e=b.clone();e.html(f);c.appendChild(e[0])}return c}function p(a){var b=a.document;if(a.collapsed)b=f(this,b,void 0),a.insertNode(b),a.moveToPosition(b,s.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,g,h=L[c];h||(g=l,h=L.span);var i=a.createBookmark();a.enlarge(s.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,m=k,o;m&&m[0];){var n=t;if(A.equals(m,j))m=C,n=l;else{var p=m[0].nodeType,r=p==A.NodeType.ELEMENT_NODE?m.nodeName():C;if(r&&m.attr("_ke_bookmark")){m=
m._4e_nextSourceNode(l);continue}if(!r||h[r]&&(m._4e_position(j)|w.POSITION_PRECEDING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_PRECEDING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m))){var q=m.parent();if(q&&"a"==c&&q.nodeName()==c)p=f(this,b,void 0),q._4e_moveChildren(p),q[0].parentNode.replaceChild(p[0],q[0]),p._4e_mergeSiblings();else if(q&&q[0]&&((L[q.nodeName()]||L.span)[c]||g)&&(!e.parentRule||e.parentRule(q))){if(!o&&(!r||!L.$removeEmpty[r]||(m._4e_position(j)|
w.POSITION_PRECEDING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_PRECEDING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED))o=new I(b),o.setStartBefore(m);if(p==A.NodeType.TEXT_NODE||p==A.NodeType.ELEMENT_NODE&&!m[0].childNodes.length){q=m;for(p=null;(n=!q.next(u,1))&&(p=q.parent())&&h[p.nodeName()]&&(p._4e_position(k)|w.POSITION_FOLLOWING|w.POSITION_IDENTICAL|w.POSITION_IS_CONTAINED)==w.POSITION_FOLLOWING+w.POSITION_IDENTICAL+w.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(p));)q=
p;o.setEndAfter(q)}}else n=l}else n=l;m=m._4e_nextSourceNode()}if(n&&o&&!o.collapsed){for(var n=f(this,b,void 0),q=o.getCommonAncestor(),p={},r={},v,x=null,y;n&&q&&n[0]&&q[0];){if(q.nodeName()==c){for(v in e.attributes)if(e.attributes.hasOwnProperty(v)&&!r[v]&&(y=q.attr(x)))n.attr(v)==y?n.removeAttr(v):r[v]=1;for(x in e.styles)if(e.styles.hasOwnProperty(x)&&!p[x]&&(y=q.style(x)))n.style(x)==y?n.style(x,""):p[x]=1;if(!n._4e_hasAttributes()){n=C;break}}q=q.parent()}n?(n[0].appendChild(o.extractContents()),
d(this,n),o.insertNode(n),n._4e_mergeSiblings(),M.ie||n[0].normalize()):(n=new G(b.createElement("span")),n[0].appendChild(o.extractContents()),o.insertNode(n),d(this,n),n._4e_remove(!0));o=C}}k._4e_remove();j._4e_remove();a.moveToBookmark(i);a.shrink(s.SHRINK_TEXT)}}function y(c){c.enlarge(s.ENLARGE_ELEMENT);var d=c.createBookmark(),f=d.startNode;if(c.collapsed){for(var e=new P(f.parent()),h,i=0,j;i<e.elements.length&&(j=e.elements[i])&&!(j==e.block||j==e.blockLimit);i++)if(this.checkElementRemovable(j)){var l=
c.checkBoundaryOfElement(j,s.END),k=!l&&c.checkBoundaryOfElement(j,s.START);k||l?(h=j,h.match=k?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(l=b(this),g(j,l[j.nodeName()]||l["*"])):a(this,j))}if(h){j=f;for(i=0;;i++){l=e.elements[i];if(l.equals(h))break;else if(l.match)continue;else l=l.clone();l[0].appendChild(j[0]);j=l}j["start"==h.match?"insertBefore":"insertAfter"](h);e=h.html();!e||"\u200b"==e?h.remove():M.webkit&&D(c.document.createTextNode("\u200b")).insertBefore(j)}}else{var m=d.endNode,
n=this;h=function(){for(var a=new P(f.parent()),b=new P(m.parent()),c=C,d=C,e=0;e<a.elements.length;e++){var g=a.elements[e];if(g==a.block||g==a.blockLimit)break;n.checkElementRemovable(g)&&(c=g)}for(e=0;e<b.elements.length;e++){g=b.elements[e];if(g==b.block||g==b.blockLimit)break;n.checkElementRemovable(g)&&(d=g)}d&&m._4e_breakParent(d);c&&f._4e_breakParent(c)};h();for(e=new G(f[0].nextSibling);e[0]!==m[0];){i=e._4e_nextSourceNode();if(e[0]&&e[0].nodeType==A.NodeType.ELEMENT_NODE&&this.checkElementRemovable(e)&&
(e.nodeName()==this.element?a(this,e):(j=b(this),g(e,j[e.nodeName()]||j["*"])),i[0].nodeType==A.NodeType.ELEMENT_NODE&&i.contains(f)))h(),i=new G(f[0].nextSibling);e=i}}c.moveToBookmark(d)}function v(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c]=d});return b}function j(a,b){var c="";b!==t?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;if(c){e.isArray(c)||(c=[c]);for(var d=0;d<c.length;d++){var f=c[d],g,h,i;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():a.element,h=f.attributes,i=f.styles);f=b[g]||(b[g]={});if(h){g=f.attributes=f.attributes||[];for(var j in h)h.hasOwnProperty(j)&&g.push([j.toLowerCase(),h[j]])}if(i){var f=f.styles=f.styles||[],l;for(l in i)i.hasOwnProperty(l)&&f.push([l.toLowerCase(),
i[l]])}}}return b}function a(a,d){var f=a._.definition,g=b(a),i=e.merge(f.attributes,(g[d.nodeName()]||g["*"]||{}).attributes),f=e.merge(f.styles,(g[d.nodeName()]||g["*"]||{}).styles),g=e.isEmptyObject(i)&&e.isEmptyObject(f),j;for(j in i)if(i.hasOwnProperty(j)&&!(("class"==j||a._.definition.fullMatch)&&d.attr(j)!=h(j,i[j])))g=g||!!d.hasAttr(j),d.removeAttr(j);for(var k in f)f.hasOwnProperty(k)&&!(a._.definition.fullMatch&&d.style(k)!=h(k,f[k],l))&&(g=g||!!d.style(k),d.style(k,""));c(d)}function h(a,
b,c){var d=new G("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function d(c,d){for(var f=b(c),e=d.all(c.element),h=e.length;0<=--h;)a(c,new G(e[h]));for(var i in f)if(f.hasOwnProperty(i)&&i!=c.element){e=d.all(i);for(h=e.length-1;0<=h;h--){var j=new G(e[h]);g(j,f[i])}}}function g(a,b){var d,f=b&&b.attributes;if(f)for(d=0;d<f.length;d++){var e=f[d][0],g;if(g=a.attr(e)){var h=f[d][1];(h===C||h.test&&h.test(g)||"string"==typeof h&&g==h)&&a[0].removeAttribute(e)}}if(f=b&&b.styles)for(d=
0;d<f.length;d++)if(e=f[d][0],h=a.css(e)){var i=f[d][1];(i===C||i.test&&i.test(g)||"string"==typeof i&&h==i)&&a.css(e,"")}c(a)}function c(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);b&&(b.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(c))}}var l=!0,t=!1,C=null,D=e.all,A=e.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},s=m.RANGE,z=m.Selection,w=m.POSITION,I=m.Range,G=e.Node,M=
e.UA,P=m.ElementPath,S={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=m.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,T=/#\((.+?)\)/g;m.STYLE=E;r.prototype={apply:function(a){i.call(this,a,t)},remove:function(a){i.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==E.STYLE_INLINE?p:this.type==E.STYLE_BLOCK?k:C).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==
E.STYLE_INLINE?y:C).call(this,a)},checkElementRemovable:function(a,c){if(!a)return t;var d=this._.definition,f;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return l;var e=d._AC;if(e)d=e;else{var e={},g=0,h=d.attributes;if(h)for(var i in h)h.hasOwnProperty(i)&&(g++,e[i]=h[i]);if(h=r.getStyleText(d))e.style||g++,e.style=h;e._length=g;d=d._AC=e}if(d._length){for(var k in d)if("_length"!=k&&d.hasOwnProperty(k)){g=a.attr(k)||"";if("style"==k)a:{e=d[k];g=j(g,t);"string"==typeof e&&(e=v(e));
"string"==typeof g&&(g=v(g));h=void 0;for(h in e)if(e.hasOwnProperty(h)&&!(h in g&&(g[h]==e[h]||"inherit"==e[h]||"inherit"==g[h]))){e=t;break a}e=l}else e=d[k]==g;if(e){if(!c)return l}else if(c)return t}if(c)return l}else return l}k=b(this);if(k=k[a.nodeName()]||k["*"]){if(!(d=k.attributes)&&!(f=k.styles))return l;if(d)for(e=0;e<d.length;e++)if(k=d[e][0],k=a.attr(k))if(g=d[e][1],g===C||"string"==typeof g&&k==g||g.test&&g.test(k))return l;if(f)for(e=0;e<f.length;e++)if(k=a.css(f[e][0]))if(d=f[e][1],
d===C||"string"==typeof d&&k==d||d.test&&d.test(k))return l}return t},checkActive:function(a){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,l);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==E.STYLE_INLINE&&(A.equals(d,a.block)||A.equals(d,a.blockLimit))))if((this.type!=E.STYLE_OBJECT||d.nodeName()in Q)&&this.checkElementRemovable(d,l))return l}return t}};r.getStyleText=function(a){var c=a._ST;
if(c)return c;var c=a.styles,b=a.attributes&&a.attributes.style||"",d="";b.length&&(b=b.replace(R,";"));for(var f in c)if(c.hasOwnProperty(f)){var e=c[f],g=(f+":"+e).replace(R,";");"inherit"==e?d+=g:b+=g}b.length&&(b=j(b));return a._ST=b+d};return m.Style=r},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(e){var m=e.Node,u=e.DOM,q=e.UA,r={debugUrl:function(i){var f=e.Config;f.debug||(i=i.replace(/\.(js|css)/i,"-min.$1"));-1==i.indexOf("?t")&&(i=-1!=i.indexOf("?")?i+"&":i+"?",i+="t="+encodeURIComponent(f.tag));return f.base+"editor/"+i},lazyRun:function(e,f,k){var m=e[f],o=e[k];e[f]=function(){m.apply(this,arguments);e[f]=e[k];return o.apply(this,arguments)}},getXY:function(e,f){var k=e.left,m=e.top,o=f.get("window")[0],k=k-u.scrollLeft(o),m=m-u.scrollTop(o),o=
f.get("iframe").offset(),k=k+o.left,m=m+o.top;return{left:k,top:m}},tryThese:function(e){for(var f,k=0,m=arguments.length;k<m;k++){var o=arguments[k];try{f=o();break}catch(q){}}return f},arrayCompare:function(e,f){if(!e&&!f)return!0;if(!e||!f||e.length!=f.length)return!1;for(var k=0;k<e.length;k++)if(e[k]!==f[k])return!1;return!0},clearAllMarkers:function(e){for(var f in e)e.hasOwnProperty(f)&&e[f]._4e_clearMarkers(e,!0,void 0)},ltrim:function(e){return e.replace(/^\s+/,"")},rtrim:function(e){return e.replace(/\s+$/,
"")},isNumber:function(i){return/^\d+(.\d+)?$/.test(e.trim(i))},verifyInputs:function(i){for(var f=0;f<i.length;f++){var k=new m(i[f]),n=e.trim(r.valInput(k)),o=k.attr("data-verify"),k=k.attr("data-warning");if(o&&!RegExp(o).test(n))return alert(k),!1}return!0},sourceDisable:function(e,f){e.on("sourceMode",f.disable,f);e.on("wysiwygMode",f.enable,f)},resetInput:function(e){var f=e.attr("placeholder");f&&q.ie?(e.addClass("ks-editor-input-tip"),e.val(f)):q.ie||e.val("")},valInput:function(e,f){if(void 0===
f)return e.hasClass("ks-editor-input-tip")?"":e.val();e.removeClass("ks-editor-input-tip");e.val(f)},placeholder:function(i,f){i.attr("placeholder",f);q.ie&&(i.on("blur",function(){e.trim(i.val())||(i.addClass("ks-editor-input-tip"),i.val(f))}),i.on("focus",function(){i.removeClass("ks-editor-input-tip");e.trim(i.val())==f&&i.val("")}))},htmlEncode:function(e){return!e?e:(""+e).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(i){var i=e.clone(i),
f;for(f in i)if(i.hasOwnProperty(f)){var k=i[f];e.isFunction(k)&&(i[f]=k())}return i},map:function(e,f){for(var k=0;k<e.length;k++)e[k]=f(e[k]);return e},ieEngine:document.documentMode||q.ie,preventFocus:function(e){q.ie?e.unselectable(void 0):e.attr("onmousedown","return false;")},injectDom:function(i){e.mix(u,i);for(var f in i)i.hasOwnProperty(f)&&function(f){m.prototype[f]=function(){var n=[].slice.call(arguments,0);n.unshift(this[0]);return(n=i[f].apply(null,n))&&(n.nodeType||e.isWindow(n))?new m(n):
e.isArray(n)&&(n.__IS_NODELIST||n[0]&&n[0].nodeType)?new m(n):n}}(f)},addRes:function(){var i=this.__res=this.__res||[];i.push.apply(i,e.makeArray(arguments))},destroyRes:function(){for(var i=this.__res||[],f=0;f<i.length;f++){var k=i[f];e.isFunction(k)?k():k.destroy?k.destroy():k.remove&&k.remove()}this.__res=[]},getQueryCmd:function(e){return"query"+("-"+e).replace(/-(\w)/g,function(e,i){return i.toUpperCase()})+"Value"}};return e.Editor.Utils=r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(e,m){function u(a,b){if(this._.end)return k;var d,e=this.range,c,j=this.guard,m=this.type,n=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,e.trim(),e.collapsed))return this.end(),k;if(!a&&!this._.guardLTR){var q=e.endContainer[0],r=q.childNodes[e.endOffset];this._.guardLTR=function(a,b){return b&&(q==a||"body"==o.nodeName(a))?!1:a!=r}}if(a&&!this._.guardRTL){var u=e.startContainer[0],s=0<e.startOffset&&u.childNodes[e.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(u==a||"body"==o.nodeName(a))?!1:a!=s}}var v=a?this._.guardRTL:this._.guardLTR;c=j?function(a,b){return v(a,b)===f?f:j(a,b)}:v;this.current?d=this.current[n](f,m,c):a?(d=e.endContainer,0<e.endOffset?(d=new p(d[0].childNodes[e.endOffset-1]),c(d[0])===f&&(d=k)):d=c(d,i)===f?k:d._4e_previousSourceNode(i,m,c,void 0)):(d=e.startContainer,d=new p(d[0].childNodes[e.startOffset]),d.length?c(d[0])===f&&(d=k):d=c(e.startContainer,i)===f?k:e.startContainer._4e_nextSourceNode(i,
m,c,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==f){if(!b)return d}else if(b&&this.evaluator)return f;d=d[n](f,m,c)}this.end();return this.current=k}function q(a){for(var b,d=k;b=u.call(this,a);)d=b;return d}function r(a){this.range=a;this.guard=this.evaluator=k;this._={}}var i=!0,f=!1,k=null,n=e.UA,o=e.DOM,x=m.XHTML_DTD,p=e.Node;e.augment(r,{end:function(){this._.end=1},next:function(){return u.call(this)},previous:function(){return u.call(this,i)},checkForward:function(){return u.call(this,
f,i)!==f},checkBackward:function(){return u.call(this,i,i)!==f},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,i)},reset:function(){delete this.current;this._={}},_iterator:u});e.mix(r,{blockBoundary:function(a){return function(b){return!(b.nodeType==o.NodeType.ELEMENT_NODE&&o._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function d(a){return"span"==o.nodeName(a)&&o.attr(a,"_ke_bookmark")}return function(e){var c,f;c=e.nodeType==o.NodeType.TEXT_NODE&&(f=
e.parentNode)&&d(f);c=a?c:c||d(e);return!!(b^c)}},whitespaces:function(a){return function(b){b=b.nodeType==o.NodeType.TEXT_NODE&&!e.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=r.whitespaces();return function(d){d=b(d)||d.nodeType==o.NodeType.ELEMENT_NODE&&!d.offsetHeight;return!!(a^d)}}});var y=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,v=r.whitespaces(),j=r.bookmark(),b=function(a){var b=o.nodeName(a);return j(a)||v(a)||1==a.nodeType&&b in x.$inline&&!(b in x.$empty)};m.Utils.injectDom({_4e_getBogus:function(a){a=
new p(a);do a=a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!n.ie?"br"==a.nodeName():3==a[0].nodeType&&y.test(a.text()))?a[0]:!1}});return m.Walker=r},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(e){var m=e.Editor,e=m.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};m.baseZIndex=function(e){return(m.Config.baseZIndex||1E4)+e};return e},{requires:["./base"]});
